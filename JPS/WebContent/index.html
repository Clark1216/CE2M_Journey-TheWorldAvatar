<!DOCTYPE html>
<html>
<head>
    <title>CARES Lab BMS Layout</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="css/index.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .control {
            position: absolute;
            left: 0;
            z-index: 1000;
        }

        .control.tilt {
            top: 0;
        }

        .control.rotation {
            top: 45px;
        }

        .control.zoom {
            top: 90px;
        }

        .control.zoom button{
            font-weight: normal;
        }

        .control button {
            width: 30px;
            height: 30px;
            margin: 15px 0 0 15px;
            border: 1px solid #999999;
            background: #ffffff;
            opacity: 0.6;
            border-radius: 5px;
            box-shadow: 0 0 5px #666666;
            font-weight: bold;
            text-align: center;
        }

        .control button:hover {
            opacity: 1;
            cursor: pointer;
        }

        #fieldsetCheckbox {
            width: 250px;
            position: relative;
            left: 0px;
            top: 15px;
            z-index: 1;
            margin-left: 25px;
            display: inline-block;
            background-color: rgba(0,0,0,0.4);
            padding: 5px 5px;
            color: white;
        }

        legend {
            font-size: 1em;
            color: white;
            margin-bottom: .75em;
        }

        label {
            font-weight: normal !important;
        }

        p#lat, p#lon, p#conc {
            margin-bottom: 0.5em;
        }

        div#output {
            display: none;
        }
    </style>
    <link rel="stylesheet" href="css/OSMBuildings.css">
    <script src="scripts/OSMBuildings.js"></script>
</head>

<body>

<div class="jumbotron text-center" id="topBanner">


    <a href="http://www.cares.cam.ac.uk/node/454#overlay-context=c4t-research">
        <img src="images/cam_lang_negativ1%20NEW_0.png">
    </a>

    <h1 id="head1">CARES Lab BMS Layout</h1>
    <p id="description">Real time data from CARES Lab BMS(Building Management System) which updates itself every 3 minutes.</p>

</div>

<div id="map">
    <div id="fieldsetCheckbox">
        <fieldset id="twoDimCheckbox">
            <legend>Select Orientation</legend>
            <div id="twoDim">
                <input type="checkbox" id="2d" name="dimension" value="2d">
                <label for="2d">2D</label>
            </div>
        </fieldset>
        <div id="output">
            <p id="lat">lat: <span id="latitude"></span></p>
            <p id="lon">lon: <span id="longitude"></span></p>
            <p id="conc0">concentration (0m): <span id="concentration0"></span></p>
            <p id="conc10">concentration (10m): <span id="concentration10"></span></p>
            <p id="conc20">concentration (20m): <span id="concentration20"></span></p>
            <p id="conc30">concentration (30m): <span id="concentration30"></span></p>
        </div>
    </div>
</div>

<div class="control tilt">
    <button class="dec">&#8601;</button>
    <button class="inc">&#8599;</button>
</div>

<div class="control rotation">
    <button class="inc">&#8630;</button>
    <button class="dec">&#8631;</button>
</div>

<div class="control zoom">
    <button class="dec">-</button>
    <button class="inc">+</button>
</div>

<script>

    //var loc = window.location.pathname;
    //var dir = loc.substring(0, loc.lastIndexOf('/'));
    //console.log(dir)

    var osmb = new OSMBuildings({
        baseURL: './OSMBuildings',
        zoom: 19.4,
        minZoom: 10,
        maxZoom: 25,
        rotation: 0.6,
        tilt: 45.0,
        // position: { latitude:1.304270, longitude:103.774396 },
        // change to variable latitude and longitude
        position: { latitude: 52.039479093801496, longitude: 4.357006480574263 }, // around den Haag
        // position: { latitude:1.3042168, longitude:103.7745893 }, // around NUS
        state: true, // stores map position/rotation in url
        effects: [], // effects: ['shadows']
        attribution: '© 3D <a href="https://osmbuildings.org/copyright/">OSM Buildings</a>'
    }).appendTo('map');

    osmb.addMapTiles(
        'https://{s}.tiles.mapbox.com/v3/osmbuildings.kbpalbpk/{z}/{x}/{y}.png',
        {
            attribution: '© Data <a href="https://openstreetmap.org/copyright/">OpenStreetMap</a> · © Map <a href="https://mapbox.com/">Mapbox</a>'
        }
    );

    // function fillPopup()
    // {
    //     var muri = "http://www.theworldavatar.com/BMS/06_buildings.owl";
    //
    //     $.ajax({
    //         url: "http://www.theworldavatar.com:82/getAttrList",
    //         method: "POST",
    //         data: JSON.stringify({uri: muri}),
    //         contentType: "application/json; charset=utf-8",
    //         success: function (attrPairs) {}
    //         });
    // }

    // console.log(fillPopup());

    //osmb.addGeoJSONTiles('https://{s}.data.osmbuildings.org/0.2/anonymous/tile/{z}/{x}/{y}.json');

    var fieldset = document.getElementById("fieldsetCheckbox");
    var divMap = document.getElementById("map");
    divMap.removeChild(divMap.childNodes[0]);
    divMap.appendChild(fieldset);

    // --- Rendering 3D building models --- //
    // var $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};

    var list = [
        "http://www.theworldavatar.com/107_buildings.owl#Building001",
        "http://www.theworldavatar.com/107_buildings.owl#Building002",
        "http://www.theworldavatar.com/107_buildings.owl#Building003",
        "http://www.theworldavatar.com/107_buildings.owl#Building004",
        "http://www.theworldavatar.com/107_buildings.owl#Building005",
        "http://www.theworldavatar.com/107_buildings.owl#Building006",
        "http://www.theworldavatar.com/107_buildings.owl#Building007",
        "http://www.theworldavatar.com/107_buildings.owl#Building008",
        "http://www.theworldavatar.com/107_buildings.owl#Building009",
        "http://www.theworldavatar.com/107_buildings.owl#Building010",
        "http://www.theworldavatar.com/107_buildings.owl#Building011",
        "http://www.theworldavatar.com/107_buildings.owl#Building012",
        "http://www.theworldavatar.com/107_buildings.owl#Building013",
        "http://www.theworldavatar.com/107_buildings.owl#Building014",
        "http://www.theworldavatar.com/107_buildings.owl#Building015",
        "http://www.theworldavatar.com/107_buildings.owl#Building016",
        "http://www.theworldavatar.com/107_buildings.owl#Building017",
        "http://www.theworldavatar.com/107_buildings.owl#Building018",
        "http://www.theworldavatar.com/107_buildings.owl#Building019",
        "http://www.theworldavatar.com/107_buildings.owl#Building020",
        "http://www.theworldavatar.com/107_buildings.owl#Building021",
        "http://www.theworldavatar.com/107_buildings.owl#Building022",
        "http://www.theworldavatar.com/107_buildings.owl#Building023",
        "http://www.theworldavatar.com/107_buildings.owl#Building024",
        "http://www.theworldavatar.com/107_buildings.owl#Building025",
        "http://www.theworldavatar.com/107_buildings.owl#Building026",
        "http://www.theworldavatar.com/107_buildings.owl#Building027",
        "http://www.theworldavatar.com/107_buildings.owl#Building028",
        "http://www.theworldavatar.com/107_buildings.owl#Building029",
        "http://www.theworldavatar.com/107_buildings.owl#Building030",
        "http://www.theworldavatar.com/107_buildings.owl#Building031",
        "http://www.theworldavatar.com/107_buildings.owl#Building032",
        "http://www.theworldavatar.com/107_buildings.owl#Building033"
    ]
	// change to variable url path
    $.getJSON('http://localhost:8080' + '/JPS/ADMSHelper',
        {
            listOfIRIs: JSON.stringify(list)
        },
        function(data) {
			      // console.log(data);
            var geojson = data;
            var arrayLength = geojson.length;

            for (var i = 0; i < arrayLength; i++) {

                try {
                    osmb.addGeoJSON(geojson[i]);
                }
                catch(err) {
                    console.log(err.name)
                }
                // finally {
                //     console.log(i);
                //     console.log(geojson[i]);
                // }
            }
    });

    //***************************************************************************

    osmb.highlight('w420847275','#00ff00');


    osmb.on('pointerdown', function(e) {
        // related to the tilt timers
        clearInterval(decreaseTiltTimer);
        clearInterval(increaseTiltTimer);
        
        var output = document.getElementById("output");
        
        if (output.style.display !== "none") {

	        var id = osmb.getTarget(e.detail.x, e.detail.y, function(id) {
	
	            var coordinates = osmb.unproject(e.detail.x, e.detail.y);
	
	            var longitude = coordinates["longitude"].toFixed(5);
	            var latitude = coordinates["latitude"].toFixed(5);
	
	            document.getElementById("longitude").innerHTML = longitude;
	            document.getElementById("latitude").innerHTML = latitude;
	
	            var coordinatesArray = []
	
	            if (!isNaN(latitude)) {
	              coordinatesArray.push(latitude);
	            }
	
	            if (!isNaN(longitude)) {
	              coordinatesArray.push(longitude);
	            }
	
	            if (coordinatesArray.length > 0) {
					// todo: change to variable URL path
	              $.getJSON('http://localhost:8080' + '/JPS/ADMSOutput',
	                  {
	                      coordinatesLonLat: JSON.stringify(coordinatesArray)
	                  },
	                  function(data) {
	                      // console.log(data);
	                      var concentrations = data;
	
	                      document.getElementById("concentration0").innerHTML = concentrations[2];
	                      document.getElementById("concentration10").innerHTML = concentrations[3];
	                      document.getElementById("concentration20").innerHTML = concentrations[4];
	                      document.getElementById("concentration30").innerHTML = concentrations[5];
	
	                  });
	            }
	
	            // if(id == 'w420847275')
	            // {
	            //     // alert('clicked')
	            //     window.location.assign("http://www.theworldavatar.com/BMSIndoor")
	            //
	            // }
	        });
        }
    });
    //61.0089718,132.8325304

    // osmb.addOBJ('002.obj', { latitude: 61.0089718, longitude: 132.8325304}, { id: "my_object_1"});

    osmb.on('pointermove', function(e) {
        osmb.getTarget(e.detail.x, e.detail.y, function(id) {
            if (id) {
                document.body.style.cursor = 'pointer';
                osmb.highlight(id, '#ff0000');
                //osmb.highlight('w420847275','#00ff00');

            } else {
                document.body.style.cursor = 'default';
                osmb.highlight(null);
                osmb.highlight('w420847275','#00ff00');
            }
        });
    });

    //***************************************************************************


    var twoDimCheckbox = document.querySelector('input[value="2d"]');
    var decreaseTiltTimer;
    var increaseTiltTimer;

    twoDimCheckbox.onchange = function() {
        if(twoDimCheckbox.checked) {
            clearInterval(increaseTiltTimer);

            var tilt = osmb.getTilt();

            function decreaseTilt() {
                tilt--;
                if (tilt != 0) {
                    osmb.setTilt(tilt);
                }
            }

            decreaseTiltTimer = setInterval(decreaseTilt, 15);
            decreaseTiltTimer;

            var output = document.getElementById("output");

            output.style.display = "inline";

        } else {
            clearInterval(decreaseTiltTimer);

            var tilt = osmb.getTilt();

            function increaseTilt() {
                tilt++;
                if (tilt < 45) {
                    osmb.setTilt(tilt);
                }
            }

            increaseTiltTimer = setInterval(increaseTilt, 15);
            increaseTiltTimer;

            var output = document.getElementById("output");

            if (output.style.display !== "none") {
                output.style.display = "none";

                document.getElementById("longitude").innerHTML = "";
                document.getElementById("latitude").innerHTML = "";
                document.getElementById("concentration0").innerHTML = "";
                document.getElementById("concentration10").innerHTML = "";
                document.getElementById("concentration20").innerHTML = "";
                document.getElementById("concentration30").innerHTML = "";                
            }
        }
    };

    //***************************************************************************

    var controlButtons = document.querySelectorAll('.control button');

    for (var i = 0, il = controlButtons.length; i < il; i++) {
        controlButtons[i].addEventListener('click', function(e) {
            var button = this;
            var parentClassList = button.parentNode.classList;
            var direction = button.classList.contains('inc') ? 1 : -1;
            var increment;
            var property;

            if (parentClassList.contains('tilt')) {
                property = 'Tilt';
                increment = direction*10;
            }
            if (parentClassList.contains('rotation')) {
                property = 'Rotation';
                increment = direction*10;
            }
            if (parentClassList.contains('zoom')) {
                property = 'Zoom';
                increment = direction*1;
            }
            if (property) {
                osmb['set'+ property](osmb['get'+ property]()+increment);
            }
        });
    }
</script>
</body>
</html>

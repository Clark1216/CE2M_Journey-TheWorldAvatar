version: "3.8"

services:

  adminer:
    image: adminer
    container_name: "adminer"
    ports:
      - ${ADMINER_PORT}:8080
    restart: unless-stopped
    security_opt:
      - label=disable

  ontop-pgsql:
    image: docker.cmclinnovations.com/ontop_endpoint:${ONTOP_VERSION}
    container_name: "ontop"
    build:
      args:
        ONTOP_POSTGRES_VERSION: ${ONTOP_POSTGRES_VERSION}
        ONTOP_VERSION: ${ONTOP_VERSION}
      context: ontop
      labels:
        authors: "gbrownbridge@cmclinnovations, oparry@cmclinnovations, support@cmclinnovations"
        builder: "${BUILDER}"
        description: "An Ontop image that includes the required postgresql driver and populates the template properties file."
        hash: "${HASH}"
    depends_on:
      - postgis
    environment:
      ONTOP_CORS_ALLOWED_ORIGINS: '*'
      ONTOP_DEV_MODE: '${ONTOP_DEV_MODE}'
      ONTOP_LAZY_INIT: '${ONTOP_LAZY_INIT}'
      POSTGRES_HOST: ${POSTGRES_HOST}
      POSTGRES_PORT: ${POSTGRES_PORT}
      DB: "${WORKSPACE}"
    env_file:
      - ontop/ontop.env
      - postgis/postgres.env
    ports:
      - ${ONTOP_PORT}:8080
    restart: unless-stopped
    security_opt:
      - label=disable
    volumes:
      - ./ontop/inputs/:/opt/ontop/input/

  postgis:
    image: postgis/postgis:14-3.1-alpine
    container_name: "postgis"
    environment:
      POSTGRES_HOST_AUTH_METHOD: scram-sha-256
      POSTGRES_INITDB_ARGS: "--auth-host=scram-sha-256"
      POSTGRES_DB: "${WORKSPACE}"
    env_file:
      - postgis/postgres.env
    ports:
      - ${POSTGRES_PORT}:5432
    restart: unless-stopped
    security_opt:
      - label=disable
    volumes:
      - geotifs:${GEOTIF_DIR}
      - postgis_data:/var/lib/postgresql/data

volumes:
  postgis_data: null
  geotifs: null

version: "3.8"

# Services
services:

  # Gas Grid Agent
  gas-grid-agent:
    image: docker.cmclinnovations.com/gas-grid-agent:1.0.0-SNAPSHOT
    container_name: "gas-grid-agent"
    restart: unless-stopped
    ports:
      - 4005:80
    labels:
      description: "Gas Grid Agent."
      authors: "support@cmclinnovations.com"
      builder: "${BUILDER}"
      hash: "${HASH}"

  # JPS Chatbot
  # TODO - Once this has a version and has been tagged with it, use that rather than the commit
  jps-chatbot:
    image: docker.cmclinnovations.com/jps-chatbot:1.0.0-SNAPSHOT
    build:
      context: "../../../JPS_Chatbot"
    container_name: "jps-chatbot"
    restart: unless-stopped
    labels:
      description: "Chemistry chatbot, uses NL processing and KGs to answer chemical queries."
      authors: "xz378@cam.ac.uk, support@cmclinnovations"
      builder: "${BUILDER}"
      hash: "${HASH}"

  # JPS LDF Server
  jps-ldf:
    image: docker.cmclinnovations.com/jps-ldf:1.0.0-SNAPSHOT
    build:
      context: "../../../JPS_LDF"
    container_name: "jps-ldf"
    restart: unless-stopped
    labels:
      description: "Linked Fragment server used in conjunction with the JPS Chatbot Image."
      authors: "xz378@cam.ac.uk, support@cmclinnovations"
      builder: "${BUILDER}"
      hash: "${HASH}"

  # Local execution environment for SRM Driver.
  # Note: This Image contains the SRM Driver and Intel MPI files (without
  #       any queueing functionality).
  srm-driver:
    image: docker.cmclinnovations.com/srm-driver:1.0.0-SNAPSHOT
    container_name: "srm-driver-${MODE}"
    restart: unless-stopped
    hostname: "srm-driver"
    mac_address: "1a:2b:3c:4d:5e:6f"
    labels:
      description: "Local execution environment for the SRM Driver (no Slurm)."
      authors: "support@cmclinnovations.com"
      builder: "${BUILDER}"
      hash: "${HASH}"
    volumes:
      - driver:/usr/local/srm-driver
      - mpi:/usr/local/intel-mpi
    
    
  # Kinetics Agent.
  # Note: This Image mounts a volume so that it can access the SRM Driver and
  #       Intel MPI files stored within the 'srm-driver' Image.
  kinetics-agent:
    image: "docker.cmclinnovations.com/kinetics-agent:0.0.1-SNAPSHOT"
    container_name: "kinetics-agent-${MODE}"
    restart: unless-stopped
    labels:
       description: "Tomcat server hosting the KineticsAgent service."
       authors: "support@cmclinnovations.com"
       builder: "${BUILDER}"
       hash: "${HASH}"
    volumes:
      - driver:/usr/local/srm-driver

    
  # Slurm compute node.
  # Note: This Image exists as a generic job queue/executor for any other
  #       services submitting Slurm jobs (such as the KineticsAgent).
  slurm:
    image: "docker.cmclinnovations.com/slurm:1.0.0-SNAPSHOT"
    container_name: "slurm-${MODE}"
    restart: unless-stopped
    privileged: true
    cap_add:
      - ALL
    labels:
       description: "Slurm compute node."
       authors: "support@cmclinnovations.com"
       builder: "${BUILDER}"
       hash: "${HASH}"
    volumes:
      - driver:/usr/local/srm-driver
      - mpi:/usr/local/intel-mpi
    env_file:
      - Slurm/slurm-variables.env

# Volumes
volumes:
  driver:
  mpi:
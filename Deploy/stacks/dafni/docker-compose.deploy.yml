# This configuration file should include all docker-compose options required to *deploy containers*
# for services in the 'dafni' stack
#
# Options used to generate an image from source, such as the 'build' node and 'labels' node should
# be set in docker-compose.build.yml.
#
# When adding a new service, please copy the configuration for an existing service, then modify the 
# service name, the 'image' tag (retaining 'docker.cmclinnovations.com') and the 'container_name'
# node (retaining '${CONTAINER_NAME_SUFFIX}').
# =================================================================================================

version: "3.8"


services:

  adminer:
    image: adminer
    container_name: "adminer${CONTAINER_NAME_SUFFIX}"
    ports:
      - ${ADMINER_PORT}:8080
    restart: unless-stopped
    security_opt:
      - label=disable

  blazegraph-geo:
    image: docker.cmclinnovations.com/blazegraph_geo:1.0.0-SNAPSHOT
    container_name: "blazegraph_geo${CONTAINER_NAME_SUFFIX}"
    ports:
      - ${BLAZEGRAPH_PORT}:8080
    pull_policy: if_not_present
    restart: unless-stopped
    security_opt:
      - label=disable
    volumes:
      - blazegraph_geo_data:/data

  csvkit:
    image: docker.io/jdkelley/csvkit
    container_name: "csvkit${CONTAINER_NAME_SUFFIX}"
    restart: unless-stopped
    security_opt:
      - label=disable
    volumes:
      - csvkit_data:/data

  flood-vis:
    image: docker.cmclinnovations.com/flood-vis:1.0.0-SNAPSHOT-dev
    container_name: "flood-map${CONTAINER_NAME_SUFFIX}"
    ports:
      - ${FLOODVIS_PORT}:80
    pull_policy: if_not_present
    restart: unless-stopped
    security_opt:
      - label=disable

  geoserver:
    image: docker.cmclinnovations.com/geoserver:${GEOSERVER_VERSION}
    container_name: "geoserver${CONTAINER_NAME_SUFFIX}"
    environment:
      ADMIN_PASSWORD_FILE: "/run/secrets/geoserver_admin_password"
    env_file:
      - .env
      - geoserver/geoserver.env
    ports:
     - ${GEOSERVER_PORT}:8080
    pull_policy: if_not_present
    restart: unless-stopped
    secrets:
      - geoserver_admin_password
    security_opt:
      - label=disable
    volumes:
      - geoserver_data:${GEOSERVER_DATA_DIR}
      - geoserver_grib_cache:${GRIB_CACHE_DIR}
      - geoserver_gwc:${GEOWEBCACHE_CACHE_DIR}
      - geoserver_gwc_config:${GEOWEBCACHE_CONFIG_DIR}
      - geoserver_logs:${GEOSERVER_LOG_DIR}
      - geoserver_netcfd:${NETCDF_DATA_DIR}
      - ./geoserver/webapps/geoserver/WEB-INF/web.xml:/usr/local/tomcat/webapps/geoserver/WEB-INF/web.xml

  # ontop-pgsql:
  #   image: docker.cmclinnovations.com/ontop_endpoint:${ONTOP_VERSION}
  #   container_name: "ontop${CONTAINER_NAME_SUFFIX}"
  #   depends_on:
  #     - postgis
  #   environment:
  #     ONTOP_CORS_ALLOWED_ORIGINS: '*'
  #     ONTOP_DEV_MODE: '${ONTOP_DEV_MODE}'
  #     POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
  #     POSTGRES_PORT: ${POSTGRES_PORT}
  #   env_file:
  #     - ontop/ontop.env
  #   ports:
  #     - ${ONTOP_PORT}:8080
  #   pull_policy: if_not_present
  #   restart: unless-stopped
  #   secrets:
  #     - postgres_password
  #   security_opt:
  #     - label=disable
  #   volumes:
  #     - ./ontop/obda:/opt/ontop/input
  #     - ./ontop/wait-for-it:/opt/wait-for-it

  postgis:
    image: postgis/postgis:14-3.1-alpine
    container_name: "postgis${CONTAINER_NAME_SUFFIX}"
    environment:
      POSTGRES_HOST_AUTH_METHOD: scram-sha-256
      POSTGRES_INITDB_ARGS: "--auth-host=scram-sha-256"
      POSTGRES_PASSWORD_FILE: /tmp/postgres_password
    env_file:
      - postgis/postgis.env
    ports:
      - ${POSTGRES_PORT}:5432
    restart: unless-stopped
    security_opt:
      - label=disable
    volumes:
      - postgis_data:/var/lib/postgresql/data
      - ./postgres/secrets/postgres_password:/tmp/postgres_password

  qgis:
      image: docker.cmclinnovations.com/qgis_with_ssh:release-3_20
      container_name: "qgis${CONTAINER_NAME_SUFFIX}"
      pull_policy: if_not_present
      restart: unless-stopped
      security_opt:
        - label=disable

  webvowl:
    image: ukparliament/webvowl
    container_name: "webvowl${CONTAINER_NAME_SUFFIX}"
    restart: unless-stopped
    security_opt:
      - label=disable

# The default network name is set using a docker-compose environment variable.
# Please don't modify the contents of the 'networks' node below.
networks:
  default:
    name: ${NETWORK_NAME}


secrets:
  geoserver_admin_password:
    # N.B. If you change the contents of this file, it will only propogate to
    # the server if you delete geoserver/datadir/security before (re)deploying!
    file: geoserver/secrets/admin_password
  postgres_password:
    file: postgres/secrets/postgres_password


volumes:
  blazegraph_geo_data:
  csvkit_data:
  geoserver_data:
  geoserver_grib_cache:
  geoserver_gwc:
  geoserver_gwc_config:
  geoserver_logs:
  geoserver_netcfd:
  postgis_data:
<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="initial-scale=1.0">
		<meta charset="utf-8">
		<title>Battery Placement</title>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
		<!--script type="text/javascript" src="https://cdn.jsdelivr.net/gh/geocodezip/geoxml3@master/kmz/geoxml3.js"></script-->
		<!--script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script-->
		<!--script type="text/javascript" src="scripts/geoxml3.js"></script-->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
		<!--script src="line.js"></script-->
		<script src="scripts/proj4.js"></script>
		<script src="scripts/Script.js"></script>
		<style>
			/* Always set the map height explicitly to define the size of the div
			* element that contains the map. */
			#map {
			height: 100%;
			}
			/* Optional: Makes the sample page fill the window. */
			html, body {
			height: 100%;
			margin: 0;
			padding: 0;
			}
			#head1
			{
			color: white;
			}
			#description
			{
			color: white;
			width:60%;
			margin-left: 20%;
			}
			#th, #td {
			padding: 15px;
			text-align: left;
			}
			.contourbg
			{
			opacity: 0;
			}
			#topBanner
			{
			background-color: #10616C;
			}
			#head1
			{
			color: white;
			}
			#readme-button {
			float: right;
			cursor: pointer;
			color: white;
			background: transparent;
			/*position: absolute;*/
			/*top: 55px;*/
			/*right: 690px;*/
			font-size: 20px;
			width: 30px;
			border: 2px solid white;
			border-radius: 50%;
			margin: 0px 100px 0px 0px;
			}
			#readme-text {
			display: none;
			box-sizing: border-box;
			height: 271px;
			width: 709px;
			border: 2px solid black;
			border-radius: 5px;
			padding: 5px 5px;
			margin: 0px 100px 0px 0px;
			position: absolute;
			top: 32px;
			right: 6px;
			background: white;
			z-index: 1;
			text-align: left;
			overflow-y: scroll;
			}
			#loader {
			position: absolute;
			left: 50%;
			top: 50%;
			z-index: 1;
			width: 150px;
			height: 150px;
			margin: -75px 0 0 -75px;
			border: 16px solid #f3f3f3;
			border-radius: 50%;
			border-top: 16px solid #3498db;
			width: 120px;
			height: 120px;
			-webkit-animation: spin 2s linear infinite;
			animation: spin 2s linear infinite;
			}
			@-webkit-keyframes spin {
			0% { -webkit-transform: rotate(0deg); }
			100% { -webkit-transform: rotate(360deg); }
			}
			@keyframes spin {
			0% { transform: rotate(0deg); }
			100% { transform: rotate(360deg); }
			}
		</style>
	</head>
	<body>
		<div class="jumbotron text-center" id="topBanner">
			<a href = "http://www.cares.cam.ac.uk/node/454#overlay-context=c4t-researchs">
			<img float="left" src="images/cam_lang_negativ1%20NEW_0.png"  >
			</a>
			<span id="readme-button">?</span>
			<span id="readme-text">
			The ESS agent represents a convenient decision-support framework to identify the optimal set of energy storage technologies for a specific application for the decision makers. 
			<br/>
			The technical constraints, as well as several objectives including minimizing cost, maximizing technical suitability and minimizing the environment impact of the selected technology, 
			were considered in the selection process. An augumented E-constraint method was used to find the Pareto optimum for the problem.
			<br/>
			In here, Jurong Islandâ€™s electrical, power and grid models are reverse-engineered with assumptions. 
			<br/>
			The user can enter the custom scenario that he chooses to create, and click on the button "Run Simulation". It will run the OPF simulation 
			and estimate the placement of the energy storage technologies, based on power losses identified by this OPF simulation.  
			<br/>
			Upon clicking on the load icon (red point), a pop-up window containing the information about the selected component will appear (click on the >).
			<br/>
			The user can change the load point and run another OPF simulation based on the altered load. This would propagate changes to the existing load points, but the power capacity of the battery would not be affected. 
			<h1 id="head1">Energy Storage System</h1>
		</div>
		<div class="panel panel-default">
			<div class="panel-body">
				<button type="button" id= 'run-btn'>Run Simulation</button>
				<input type="text" id="scenarioTxt" value="">
				<div style="display:none;" id="loader"></div>
			</div>
		</div>
		<div id="map"></div>
		<script>
			var branchInfo = "PREFIX j1:<http://www.theworldavatar.com/ontology/ontopowsys/PowSysRealization.owl#> "
				+ "PREFIX j2:<http://www.theworldavatar.com/ontology/ontocape/upper_level/system.owl#> "
				+ "PREFIX j3:<http://www.theworldavatar.com/ontology/ontopowsys/model/PowerSystemModel.owl#> "
				+ "PREFIX j4:<http://www.theworldavatar.com/ontology/meta_model/topology/topology.owl#> "
				+ "PREFIX j5:<http://www.theworldavatar.com/ontology/ontocape/model/mathematical_model.owl#> "
				+ "PREFIX j6:<http://www.theworldavatar.com/ontology/ontocape/chemical_process_system/CPS_behavior/behavior.owl#> "
				+ "PREFIX j7:<http://www.theworldavatar.com/ontology/ontocape/supporting_concepts/space_and_time/space_and_time_extended.owl#> "
				+ "PREFIX j8:<http://www.theworldavatar.com/ontology/ontocape/material/phase_system/phase_system.owl#> "
				+ "SELECT ?entity ?V_R ?V_X ?V_B ?V_RateA ?V_RateB ?V_RateC ?V_RatioCoeff ?V_Angle ?V_Angle_unit ?V_Status ?V_AngleMin ?V_AngleMin_unit ?V_AngleMax ?V_AngleMax_unit ?V_ToBusNumber "
			
				+ "WHERE {?entity  a  j1:UndergroundCable  ." 
				+ "?entity   j2:isModeledBy ?model ."
				+ "?model   j5:hasModelVariable ?res ." 
			
				+ "?res  a  j3:R  ." 
				+ "?res  j2:hasValue ?vres ."
				+ "?vres   j2:numericalValue ?V_R ." // resistance
				+ "?vres   j2:hasUnitOfMeasure ?V_R_unit ." // resistance
			
				+ "?model   j5:hasModelVariable ?rea ." 
				+ "?rea  a  j3:X  ." 
				+ "?rea  j2:hasValue ?vrea ."
				+ "?vrea   j2:numericalValue ?V_X ." // reactance
			
				+ "?model   j5:hasModelVariable ?sus ." 
				+ "?sus  a  j3:B  ." 
				+ "?sus  j2:hasValue ?vsus ."
				+ "?vsus   j2:numericalValue ?V_B ." // susceptance
			
				+ "?model   j5:hasModelVariable ?ratea ." 
				+ "?ratea  a  j3:RateA  ." 
				+ "?ratea  j2:hasValue ?vratea ."
				+ "?vratea   j2:numericalValue ?V_RateA ." // rateA
			
				+ "?model   j5:hasModelVariable ?rateb ." 
				+ "?rateb  a  j3:RateB  ." 
				+ "?rateb  j2:hasValue ?vrateb ."
				+ "?vrateb   j2:numericalValue ?V_RateB ." // rateB
			
				+ "?model   j5:hasModelVariable ?ratec ." 
				+ "?ratec  a  j3:RateC  ." 
				+ "?ratec  j2:hasValue ?vratec ."
				+ "?vratec   j2:numericalValue ?V_RateC ." // rateC
			
				+ "?model   j5:hasModelVariable ?ratio ." 
				+ "?ratio  a  j3:RatioCoefficient  ."
				+ "?ratio  j2:hasValue ?vratio ." 
				+ "?vratio   j2:numericalValue ?V_RatioCoeff ." // ratio
			
				+ "?model   j5:hasModelVariable ?ang ." 
				+ "?ang  a  j3:Angle  ." 
				+ "?ang  j2:hasValue ?vang ."
				+ "?vang   j2:numericalValue ?V_Angle ." // angle
				+ "?vang   j2:hasUnitOfMeasure ?V_Angle_unit ." // angle
			
				+ "?model   j5:hasModelVariable ?stat ." 
				+ "?stat  a  j3:BranchStatus ." 
				+ "?stat  j2:hasValue ?vstat ."
				+ "?vstat   j2:numericalValue ?V_Status ." // status
			
				+ "?model   j5:hasModelVariable ?tobusnum ." 
				+ "?tobusnum  a  j3:BranchStatus ." 
				+ "?tobusnum  j2:hasValue ?vtobusnum ."
				+ "?vtobusnum   j2:numericalValue ?V_ToBusNumber ." // status
			
				+ "?model   j5:hasModelVariable ?angmin ." 
				+ "?angmin  a  j3:AngleMin  ."
				+ "?angmin  j2:hasValue ?vangmin ." 
				+ "?vangmin   j2:numericalValue ?V_AngleMin ." // anglemin
				+ "?vangmin   j2:hasUnitOfMeasure ?V_AngleMin_unit ." // anglemin
			
				+ "?model   j5:hasModelVariable ?angmax ." 
				+ "?angmax  a  j3:AngleMax  ."
				+ "?angmax  j2:hasValue ?vangmax ." 
				+ "?vangmax   j2:numericalValue ?V_AngleMax ." // anglemax
				+ "?vangmax   j2:hasUnitOfMeasure ?V_AngleMax_unit ." // anglemin
			
				+ "}";
			var busInfo = "PREFIX j1:<http://www.theworldavatar.com/ontology/ontopowsys/PowSysRealization.owl#> "
				+ "PREFIX j2:<http://www.theworldavatar.com/ontology/ontocape/upper_level/system.owl#> "
				+ "PREFIX j3:<http://www.theworldavatar.com/ontology/ontopowsys/model/PowerSystemModel.owl#> "
				+ "PREFIX j4:<http://www.theworldavatar.com/ontology/meta_model/topology/topology.owl#> "
				+ "PREFIX j5:<http://www.theworldavatar.com/ontology/ontocape/model/mathematical_model.owl#> "
				+ "PREFIX j7:<http://www.theworldavatar.com/ontology/ontocape/supporting_concepts/space_and_time/space_and_time_extended.owl#> "
				+ "SELECT ?entity ?V_Pd ?V_Pd_unit ?V_Pd_Gen ?V_Pd_Gen_unit ?V_Gd ?V_Gd_unit ?V_Gd_Gen ?V_Gd_Gen_unit " 
				+ "?V_Gs ?V_Bs ?V_Vm ?V_Va ?V_Va_unit ?V_BaseKV ?V_BaseKV_unit ?V_VmMax ?V_VmMin ?V_x ?V_x_unit ?V_y ?V_y_unit "
			
				+ "WHERE {?entity  a  j1:BusNode  ." 
				+ "?entity   j2:isModeledBy ?model ."
			
				+ "?model   j5:hasModelVariable ?Pd ." 
				+ "?Pd  a  j3:PdBus  ." 
				+ "?Pd  j2:hasValue ?vpd ."
				+ "?vpd   j2:numericalValue ?V_Pd ." // pd
				+ "?vpd   j2:hasUnitOfMeasure ?V_Pd_unit ." // pd unit
			
				+ "?model   j5:hasModelVariable ?PdGen ." 
				+ "?PdGen  a  j3:PdGen  ." 
				+ "?PdGen  j2:hasValue ?vpdgen ."
				+ "?vpdgen   j2:numericalValue ?V_Pd_Gen ." // pdgen
				+ "?vpdgen   j2:hasUnitOfMeasure ?V_Pd_Gen_unit ." // pdgen
				
				+ "?model   j5:hasModelVariable ?Gd ." 
				+ "?Gd  a  j3:GdBus  ." 
				+ "?Gd  j2:hasValue ?vgd ."
				+ "?vgd   j2:numericalValue ?V_Gd ." // Gd
				+ "?vgd   j2:hasUnitOfMeasure ?V_Gd_unit ." // Gd
				
				+ "?model   j5:hasModelVariable ?Gd_Gen ." 
				+ "?Gd_Gen  a  j3:GdGen  ." 
				+ "?Gd_Gen  j2:hasValue ?vgdgen ."
				+ "?vgdgen   j2:numericalValue ?V_Gd_Gen ." // Gdgen
				+ "?vgdgen   j2:hasUnitOfMeasure ?V_Gd_Gen_unit ." // Gdgen
			
			
				+ "?model   j5:hasModelVariable ?Gsvar ." 
				+ "?Gsvar  a  j3:Gs  ." 
				+ "?Gsvar  j2:hasValue ?vGsvar ."
				+ "?vGsvar   j2:numericalValue ?V_Gs ." // Gs (has no unit)
			
				+ "?model   j5:hasModelVariable ?Bsvar ." 
				+ "?Bsvar  a  j3:Bs  ." 
				+ "?Bsvar  j2:hasValue ?vBsvar ."
				+ "?vBsvar   j2:numericalValue ?V_Bs ." // Bs (has no unit)
			
				+ "?model   j5:hasModelVariable ?VM ." 
				+ "?VM  a  j3:Vm  ." 
				+ "?VM  j2:hasValue ?vVM ."
				+ "?vVM   j2:numericalValue ?V_Vm ." // Vm
			
				+ "?model   j5:hasModelVariable ?VA ." 
				+ "?VA  a  j3:Va  ." 
				+ "?VA  j2:hasValue ?vVA ."
				+ "?vVA   j2:numericalValue ?V_Va ." // Va
				+ "?vVA   j2:hasUnitOfMeasure ?V_Va_unit ." // Va
			
				+ "?model   j5:hasModelVariable ?BKV ." 
				+ "?BKV  a  j3:baseKV  ." 
				+ "?BKV  j2:hasValue ?vBKV ."
				+ "?vBKV   j2:numericalValue ?V_BaseKV ." // Base KV
				+ "?vBKV   j2:hasUnitOfMeasure ?V_BaseKV_unit ." // Base KV
				
				+ "?model   j5:hasModelVariable ?vmaxvar ." 
				+ "?vmaxvar  a  j3:VmMax  ."
				+ "?vmaxvar  j2:hasValue ?vvmaxvar ." 
				+ "?vvmaxvar   j2:numericalValue ?V_VmMax ." // Vmax
			
				+ "?model   j5:hasModelVariable ?vminvar ." 
				+ "?vminvar  a  j3:VmMin  ."
				+ "?vminvar  j2:hasValue ?vvminvar ." 
				+ "?vvminvar   j2:numericalValue ?V_VmMin ." // Vmin
						
				+ "?coorsys  j7:hasProjectedCoordinate_y  ?y  ." 
				+ "?y  j2:hasValue ?vy ." 
				+ "?vy  j2:numericalValue ?V_y ."//longitude
				+ "?vy  j2:hasUnitOfMeasure ?V_y_unit ."//longitude
			
				+ "?coorsys  j7:hasProjectedCoordinate_x  ?x  ."
				+ "?x  j2:hasValue ?vx ." 
				+ "?vx  j2:numericalValue ?V_x ."//latitude
				+ "?vx  j2:hasUnitOfMeasure ?V_x_unit ."//latitude
				
			
				+ "}";
			var genInfo = "PREFIX j1:<http://www.theworldavatar.com/ontology/ontopowsys/PowSysRealization.owl#> "
				+ "PREFIX j2:<http://www.theworldavatar.com/ontology/ontocape/upper_level/system.owl#> "
				+ "PREFIX j3:<http://www.theworldavatar.com/ontology/ontopowsys/model/PowerSystemModel.owl#> "
				+ "PREFIX j5:<http://www.theworldavatar.com/ontology/ontocape/model/mathematical_model.owl#> "
				+ "PREFIX j7:<http://www.theworldavatar.com/ontology/ontocape/supporting_concepts/space_and_time/space_and_time_extended.owl#> "
				+ "PREFIX j9:<http://www.theworldavatar.com/ontology/ontoeip/system_aspects/system_performance.owl#> "
				+ "PREFIX technical_system:<http://www.theworldavatar.com/ontology/ontocape/upper_level/technical_system.owl#> "
				+ "SELECT ?entity ?V_BusNumber ?V_PGen ?V_PGen_unit ?V_QGen ?V_QGen_unit ?V_Qmax ?V_Qmax_unit ?V_Qmin ?V_Qmin_unit ?V_Vg ?V_mBase ?V_mBase_unit "
				+ "?V_Pmax ?V_Pmax_unit ?V_Pmin ?V_Pmin_unit ?V_Pc1 ?V_Pc2 ?V_Qc1Min ?V_Qc1Max "
				+ "?V_Qc2Min ?V_Qc2Max ?V_Ramp_agc ?V_Ramp_10 ?V_Ramp_30 ?V_Ramp_q ?V_APF "
				+ "?V_StartupCost ?V_ShutdownCost ?V_genCostn ?V_genCostn1 ?V_genCostn2 ?V_genCostc0 "
			
				+ "WHERE {?entity  a  j1:PowerGenerator  ."
				+ "?entity   j2:isModeledBy ?model ."
			
				+ "?model   j5:hasModelVariable ?num ." 
				+ "?num  a  j3:BusNumber  ." 
				+ "?num  j2:hasValue ?vnum ."
				+ "?vnum   j2:numericalValue ?V_BusNumber ." // number
			
				+ "?model   j5:hasModelVariable ?Pg ." 
				+ "?Pg  a  j3:Pg  ." 
				+ "?Pg  j2:hasValue ?vpg ."
				+ "?vpg   j2:numericalValue ?V_PGen ." // pg
				+ "?vpg   j2:hasUnitOfMeasure ?V_PGen_unit ." // pg
			
				+ "?model   j5:hasModelVariable ?Qg ." 
				+ "?Qg  a  j3:Qg  ." 
				+ "?Qg  j2:hasValue ?vqg ."
				+ "?vqg   j2:numericalValue ?V_QGen ." // qg
				+ "?vqg   j2:hasUnitOfMeasure ?V_QGen_unit ." // qg
			
				+ "?model   j5:hasModelVariable ?qmax ." 
				+ "?qmax  a  j3:QMax  ." 
				+ "?qmax  j2:hasValue ?vqmax ."
				+ "?vqmax   j2:numericalValue ?V_Qmax ." // qmax
				+ "?vqmax   j2:hasUnitOfMeasure ?V_Qmax_unit ." // qmax
			
				+ "?model   j5:hasModelVariable ?qmin ." 
				+ "?qmin  a  j3:QMin  ." 
				+ "?qmin  j2:hasValue ?vqmin ."
				+ "?vqmin   j2:numericalValue ?V_Qmin ." // qmin
				+ "?vqmin   j2:hasUnitOfMeasure ?V_Qmin_unit ." // qmin
			
				+ "?model   j5:hasModelVariable ?Vg ." 
				+ "?Vg  a  j3:Vg  ." 
				+ "?Vg  j2:hasValue ?vVg ."
				+ "?vVg   j2:numericalValue ?V_Vg ." // vg
			
				+ "OPTIONAL{?model   j5:hasModelVariable ?mbase }" 
				+ "OPTIONAL{?mbase  a  j3:mBase  }" 
				+ "OPTIONAL{?mbase  j2:hasValue ?vmbase }"
				+ "OPTIONAL{?vmbase   j2:numericalValue ?V_mBase }" // mbase
				+ "OPTIONAL{?vmbase   j2:hasUnitOfMeasure ?V_mBase_unit }" // mbase
			
				+ "?model   j5:hasModelVariable ?pmax ." 
				+ "?pmax  a  j3:PMax  ." 
				+ "?pmax  j2:hasValue ?vpmax ."
				+ "?vpmax   j2:numericalValue ?V_Pmax ." // pmax
				+ "?vpmax   j2:hasUnitOfMeasure  ?V_Pmax_unit ." // pmax
			
				+ "?model   j5:hasModelVariable ?pmin ." 
				+ "?pmin  a  j3:PMin  ." 
				+ "?pmin  j2:hasValue ?vpmin ."
				+ "?vpmin   j2:numericalValue ?V_Pmin ." // pmin
				+ "?vpmin   j2:hasUnitOfMeasure?V_Pmin_unit ." // pmin
			
				+ "?model   j5:hasModelVariable ?pc1 ." 
				+ "?pc1  a  j3:Pc1  ." 
				+ "?pc1  j2:hasValue ?vpc1 ."
				+ "?vpc1   j2:numericalValue ?V_Pc1 ." // pc1
			
				+ "?model   j5:hasModelVariable ?pc2 ." 
				+ "?pc2  a  j3:Pc2  ." 
				+ "?pc2  j2:hasValue ?vpc2 ."
				+ "?vpc2   j2:numericalValue ?V_Pc2 ." // pc2
			
				+ "?model   j5:hasModelVariable ?qc1min ." 
				+ "?qc1min  a  j3:QC1Min  ."
				+ "?qc1min  j2:hasValue ?vqc1min ." 
				+ "?vqc1min   j2:numericalValue ?V_Qc1Min ." // qc1min
			
				+ "?model   j5:hasModelVariable ?Qc1max ." 
				+ "?Qc1max  a  j3:QC1Max  ."
				+ "?Qc1max  j2:hasValue ?vQc1max ." 
				+ "?vQc1max   j2:numericalValue ?V_Qc1Max ." // qc1max
			
				+ "?model   j5:hasModelVariable ?qc2min ." 
				+ "?qc2min  a  j3:QC2Min  ."
				+ "?qc2min  j2:hasValue ?vqc2min ."
				+ "?vqc2min   j2:numericalValue ?V_Qc2Min ." // qc2min
			
				+ "?model   j5:hasModelVariable ?Qc2max ."
				+ "?Qc2max  a  j3:QC2Max  ."
				+ "?Qc2max  j2:hasValue ?vQc2max ." 
				+ "?vQc2max   j2:numericalValue ?V_Qc2Max ." // qc2max
			
				+ "?model   j5:hasModelVariable ?rampagc ." 
				+ "?rampagc  a  j3:Rampagc  ."
				+ "?rampagc  j2:hasValue ?vrampagc ." 
				+ "?vrampagc   j2:numericalValue ?V_Ramp_agc ." // rampagc
			
				+ "?model   j5:hasModelVariable ?ramp10 ." 
				+ "?ramp10  a  j3:Ramp10  ."
				+ "?ramp10  j2:hasValue ?vramp10 ."
				+ "?vramp10   j2:numericalValue ?V_Ramp_10 ." // ramp10
			
				+ "?model   j5:hasModelVariable ?ramp30 ." 
				+ "?ramp30  a  j3:Ramp30  ."
				+ "?ramp30  j2:hasValue ?vramp30 ." 
				+ "?vramp30   j2:numericalValue ?V_Ramp_30 ." // ramp30
			
				+ "?model   j5:hasModelVariable ?rampq ." 
				+ "?rampq  a  j3:Rampq  ." 
				+ "?rampq  j2:hasValue ?vrampq ."
				+ "?vrampq   j2:numericalValue ?V_Ramp_q ." // rampq
			
				+ "?model   j5:hasModelVariable ?apf ."
				+ "?apf  a  j3:APF  ." 
				+ "?apf  j2:hasValue ?vapf ."
				+ "?vapf   j2:numericalValue ?V_APF ." // apf
				
				+ "?model   j5:hasModelVariable ?startup ." 
				+ "?startup  a  j3:StartCost  ."
				+ "?startup  j2:hasValue ?vstartup ." 
				+ "?vstartup   j2:numericalValue ?V_StartupCost ." //startup cost
			
				+ "?model   j5:hasModelVariable ?shutdown ." 
				+ "?shutdown  a  j3:StopCost  ."
				+ "?shutdown  j2:hasValue ?vshutdown ." 
				+ "?vshutdown   j2:numericalValue ?V_ShutdownCost ."  //shutdown cost
				
				+ "?model   j5:hasModelVariable ?gencostn ." 
				+ "?gencostn  a  j3:genCostn  ."
				+ "?gencostn  j2:hasValue ?vgencostn ." 
				+ "?vgencostn   j2:numericalValue ?V_genCostn ." //genCostn
			
				+ "?model   j5:hasModelVariable ?gencostn1 ." 
				+ "?gencostn1  a  j3:genCostcn-1  ."
				+ "?gencostn1  j2:hasValue ?vgencostn1 ." 
				+ "?vgencostn1   j2:numericalValue ?V_genCostn1 ." //genCostn-1
			
				+ "?model   j5:hasModelVariable ?gencostn2 ." 
				+ "?gencostn2  a  j3:genCostcn-2  ."
				+ "?gencostn2  j2:hasValue ?vgencostn2 ." 
				+ "?vgencostn2   j2:numericalValue ?V_genCostn2 ."//genCostn-2
			
				+ "?model   j5:hasModelVariable ?gencostc ." 
				+ "?gencostc  a  j3:genCostc0  ."
				+ "?gencostc  j2:hasValue ?vgencostc ." 
				+ "?vgencostc   j2:numericalValue ?V_genCostc0 ." //genCostc0
			
				+ "}";
			var genInfo2 = "PREFIX j1:<http://www.theworldavatar.com/ontology/ontopowsys/PowSysRealization.owl#> "
					+ "PREFIX j2:<http://www.theworldavatar.com/ontology/ontocape/upper_level/system.owl#> "
					+ "PREFIX j3:<http://www.theworldavatar.com/ontology/ontopowsys/model/PowerSystemModel.owl#> "
					+ "PREFIX j5:<http://www.theworldavatar.com/ontology/ontocape/model/mathematical_model.owl#> "
					+ "PREFIX j7:<http://www.theworldavatar.com/ontology/ontocape/supporting_concepts/space_and_time/space_and_time_extended.owl#> "
					+ "PREFIX j9:<http://www.theworldavatar.com/ontology/ontoeip/system_aspects/system_performance.owl#> "
					+ "PREFIX technical_system:<http://www.theworldavatar.com/ontology/ontocape/upper_level/technical_system.owl#> "
					+ "SELECT ?entity ?V_x ?V_x_unit ?V_y ?V_y_unit ?V_Actual_CO2_Emission ?V_Actual_CO2_Emission_unit ?V_Design_CO2_Emission ?V_Design_CO2_Emission_unit "
			
					+ "WHERE {?entity  a  j1:PowerGenerator  ."
					+ "?entity   technical_system:realizes ?generation ."
			
					+ "?generation j9:hasEmission ?emission ." 
					+ "?emission a j9:Actual_CO2_Emission ."
					+ "?emission   j2:hasValue ?valueemission ."
					+ "?valueemission   j2:numericalValue ?V_Actual_CO2_Emission ." //
					+ "?valueemission   j2:hasUnitOfMeasure ?V_Actual_CO2_Emission_unit ." //
			
					+ "?v_emission a j9:CO2_emission ."
					+ "OPTIONAL {?v_emission   j2:hasValue ?valueemission_d }"
					+ "OPTIONAL {?valueemission_d   j2:numericalValue ?V_Design_CO2_Emission }" //
					+ "OPTIONAL {?valueemission_d   j2:hasUnitOfMeasure ?V_Design_CO2_Emission_unit }" //
			
					+ "?coorsys  j7:hasProjectedCoordinate_y  ?y  ." 
					+ "?y  j2:hasValue ?vy ." 
					+ "?vy  j2:numericalValue ?V_y ."
					+ "?vy  j2:hasUnitOfMeasure ?V_y_unit ."
					//
					+ "?coorsys  j7:hasProjectedCoordinate_x  ?x  ."
					+ "?x  j2:hasValue ?vx ." 
					+ "?vx  j2:numericalValue ?V_x ."//longitude
					+ "?vx  j2:hasUnitOfMeasure ?V_x_unit ."//longitude
			
			
					+ "}";
				var batteryInfo ="PREFIX j1:<http://www.theworldavatar.com/ontology/ontopowsys/PowSysRealization.owl#> "
					+ "PREFIX j2:<http://www.theworldavatar.com/ontology/ontocape/upper_level/system.owl#> "
					+ "PREFIX j3:<http://www.theworldavatar.com/ontology/ontopowsys/model/PowerSystemModel.owl#> "
					+ "PREFIX j4:<http://www.theworldavatar.com/ontology/meta_model/topology/topology.owl#> "
					+ "PREFIX j5:<http://www.theworldavatar.com/ontology/ontocape/model/mathematical_model.owl#> "
					+ "PREFIX j6:<http://www.theworldavatar.com/ontology/ontocape/chemical_process_system/CPS_behavior/behavior.owl#> "
					+ "PREFIX j7:<http://www.theworldavatar.com/ontology/ontocape/supporting_concepts/space_and_time/space_and_time_extended.owl#> "
					+ "PREFIX j8:<http://www.theworldavatar.com/ontology/ontocape/material/phase_system/phase_system.owl#> "
					+ "PREFIX j9:<http://www.theworldavatar.com/ontology/ontopowsys/PowSysBehavior.owl#> "
					+ "PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#> "
					
					+ "SELECT ?entity ?V_x ?V_x_unit ?V_y ?V_y_unit ?V_ActivePowerInjection_of_VRB ?V_ActivePowerInjection_of_VRB_unit "
					+ "WHERE {?entity  a  j1:VanadiumRedoxBattery ."
			
					+ "?entity   j9:hasActivePowerInjection ?cap ."
					+"?cap j2:hasValue ?vcap ."
					+"?vcap  j2:numericalValue ?V_ActivePowerInjection_of_VRB ."
					+"?vcap  j2:hasUnitOfMeasure ?V_ActivePowerInjection_of_VRB_unit ."
			
					+ "?entity   j7:hasGISCoordinateSystem ?coorsys ."
			
					+ "?coorsys  j7:hasProjectedCoordinate_y  ?y  ."
					+ "?y  j2:hasValue ?vy ." 
					+ "?vy  j2:numericalValue ?V_y ."
					+ "?vy  j2:hasUnitOfMeasure ?V_y_unit ."
			
					+ "?coorsys  j7:hasProjectedCoordinate_x  ?x  ."
					+ "?x  j2:hasValue ?vx ." 
					+ "?vx  j2:numericalValue ?V_x ."//longitude
					+ "?vx  j2:hasUnitOfMeasure ?V_x_unit ."//longitude
			
					+ " {?class rdfs:subClassOf j1:Battery ."
					+ "} "
					+ "UNION { ?class rdfs:subClassOf j1:EnergyStorageSystem . } ."
					+ "}";
						
			var opt = 'OPF';
			var globalKMLEventinfoWindowHtml;
			var selectedId;
			var txt;
			var scenario = "base";
			//var prefix = "http://localhost:8080"
			var prefix = "http://www.theworldavatar.com"
			//var prefix = "http://www.jparksimulator.com"
			var electricalnetwork='http://www.jparksimulator.com/kb/sgp/jurongisland/jurongislandpowernetwork/JurongIslandPowerNetwork.owl#JurongIsland_PowerNetwork';
			var batIRI="http://www.theworldavatar.com/kb/batterycatalog/BatteryCatalog.owl#BatteryCatalog";
			var pvGenIRI=["http://www.theworldavatar.com/kb/sgp/semakauisland/semakauelectricalnetwork/PV-001.owl#PV-001"];//to be a jsonarray
			var colorMap = ['#99f','#f99','#9f9','#f9f','#39f'];
			var markers = [];
			var animatedLines = [];
			var batterylist;
			var infowindow;
			 
			 
			// Perform other work here ...
			 
			// Set another completion function for the request above
			 
					 const toggleDisplay = elemId => {
					let x = document.getElementById(elemId);
					if (x.style.display !== 'block') {
						x.style.display = 'block';
					} else {
						x.style.display = 'none';
					}
				};
			
				$("#readme-button").click(function() {
					toggleDisplay("readme-text");
				});
			
				document.addEventListener("click", function(evt) {
					var readmeButtonElement = document.getElementById('readme-button'),
						readmeTextElement = document.getElementById('readme-text'),
						targetElement = evt.target;  // clicked element
			
					if (targetElement == readmeButtonElement || targetElement == readmeTextElement) {
						return; //readme-button or readme-text is clicked. do nothing.
					}
			
					if(readmeTextElement.style.display === 'block') {
						readmeTextElement.style.display = 'none';
					}
				}); 
				
				function Branch(coors, vols, thickness,type,name) {
					this.name = name;
					this.vols = vols;
					this.thickness = thickness;
					this.type = type;
					this.coors = coors;
				}
				
				function point(lat, lng) {
					this.lat = lat;
					this.lng = lng;
				}
					
				function initMap() {
					map = new google.maps.Map(document.getElementById('map'), {
						zoom: 14,
						center: {lat: 1.2624421, lng: 103.7007045}
					});
					infowindow = new google.maps.InfoWindow({
			            content: '<h2>Sup!</h2>'
			        });
			
				}
				document.getElementById("run-btn").addEventListener("click", drawBattery);
				function drawLines(){
					clearMarkers();
					clearAnimatedLines();
					//load the line at the starting
					var agenturl = prefix + '/JPS_POWSYS/ENVisualization/createLineJS';
			        var url = createUrlForAgent(scenario, agenturl, {"electricalnetwork":electricalnetwork});
					var lines=[];
					var request = $.ajax({
						url: url,
						type: 'GET',
						contentType: 'application/json; charset=utf-8'
					});
					
					request.done(function(data) {
					
					
					obj0 = JSON.parse(data).result;
					var line223 ="{\"coors\": [{\"lat\": "+String(1.206334)+", \"lng\": "+String(103.780312)+"}, {\"lat\": "+String(1.2794833)+", \"lng\": "+String(103.7271667)+"}], \"vols\": ["+String(228.0)+","+String(227.0)+"], \"thickness\": "+String(6)+", \"type\": \""+"distribute"+"\", \"name\": \"/"+"/Eline-221.owl\"}";
				    obj0.push(line223);
				    console.log(obj0);
					var size=obj0.length;
					console.log("size="+size);   
			
					//Temporary: Because there are two lines created due to Parallel World, need to get rid of them. 
					
					var x;
					for(x=0;x<size;x++){
						var obj = JSON.parse(obj0[x]);  
						var point0= new point(obj.coors[0].lat,obj.coors[0].lng);
						var point1= new point(obj.coors[1].lat,obj.coors[1].lng);
						var temparr=[point0,point1];
						var vol0=obj.vols[0];			
						var vol1=obj.vols[1];
						var temparrvol=[vol0,vol1];
						
						
						var line = new Branch(temparr,temparrvol, obj.thickness, obj.type,obj.name);
						// console.log("linepoint0long="+temparr[0].lng);
						
						lines.push(line);
					}
					console.log('lines ',lines , ' size of lines ', lines.length);
						
				
				batterycount = 0;
					for (var index in lines){
						var _line = lines[index];
						var _name = _line['name'];
						var _type = _line['type'];
			
						// console.log('--_type--',_type);
						
						
						var _path = _line['coors'];
			
			
						var _thickness = _line['thickness'];
						var lineSymbol = {
							path: google.maps.SymbolPath.FORWARD_OPEN_ARROW,
							scale:2,
							strokeColor: '#333'
						};
						
			
						if(_type === 'distribute')
						{
						//console.log('--_name--',_name);
							var line = new google.maps.Polyline({
								path: _path,
								strokeWeight: _thickness,
								strokeColor : colorMap[_thickness - 3],
								 icons: [{icon: lineSymbol,
											offset: '100%'
										}],
								map: map,
								title: _name
							});
			
							
			
			                google.maps.InfoWindow.prototype.opened = false;
							google.maps.event.addListener(line, 'click', function(lineEvent) {
								var that = this;
								var content = constructLineMenu(this.title,function (_content) {
									console.log('content',_content);
									infowindow.setContent(_content);
								});
								marker = new google.maps.Marker({
			                                position: lineEvent.latLng,
			                                map: map,
			                              });
			                              marker.addListener('click', function() {
			                                infowindow.open(map, marker);
			                              });
			                              marker.addListener('dblclick', function() {
			                                infowindow.close();
			                                marker.setMap(null);
			                                marker = null;
			                              });
			                    markers.push(marker);
							});
							animateCircle(line,1);
			                animatedLines.push(line);
						}
						
						
			
			
			
			
					}
					});
			
					request.fail(function(jqXHR, textStatus) {
						// your failure code here
					});
					
			
					var kmljson = {};
					kmljson["electricalnetwork"] = electricalnetwork;
					kmljson['flag']  = scenario;
					var agenturl = prefix + '/JPS_POWSYS/ENVisualization/createKMLFile';  
					var kmlurl = createUrlForAgent(scenario, agenturl, kmljson);
					
					console.log(kmlurl);
					var kmldataurl;
					var request = $.ajax({
						url: kmlurl,
						type: 'GET',
						contentType: 'application/json; charset=utf-8'
					});
			
							request.done(function(data) {
							console.log ("success create request");
									var kmlLayer = new google.maps.KmlLayer({
										//url: 'http://theworldavatar.com/OntoEN/testfinal'+scenario+'.kml'+ "?r="+(new Date()).getTime(),
										url:'https://sites.google.com/site/kmlfilescares/kmltest1/testfinalBASE.kml'+ "?r="+(new Date()).getTime(),
										suppressInfoWindows: false,
										map: map
									});
										kmlLayer.addListener('click', function(kmlEvent) {
										setKMLMenu(kmlEvent)
									});     
								
							});
							
			
				request.fail(function(jqXHR, textStatus) {
					console.log(jqXHR);
					console.log(textStatus);
				});
				}
				function drawMarkers(){
				    var agenturl=  prefix + '/JPS_POWSYS/ENVisualization/createMarkers'; 
				    var kmlurl = createUrlForAgent(scenario, agenturl, {"electricalnetwork":electricalnetwork});
				    console.log(kmlurl);
				    var request = $.ajax({
				        url: kmlurl,
				        type: 'GET',
				        async: true,
				        contentType: 'application/json; charset=utf-8'
				    });     
				    
				    request.done(function(data) {
				        var obj0 = JSON.parse(data).result;
				        var size=obj0.length; 
				        
				    //We currently know of a few cases:
				    var x;
				    // scan some duplicates
				    dict = {"solar": 0, "gas": 0, "oil": 0};
				    var markerdict = new Map();
				    var latLng = new Map();
				    for (x=0; x< size; x++){
				        var obj = JSON.parse(obj0[x]);  
				        var fueltype = obj.fueltype;
				        var name = obj.name;
				        if (fueltype== "NaturalGasGeneration"){
				            var icon = {
				                url: 'images/naturalgas.png',
				                scaledSize : new google.maps.Size(40, 40),
				            };
				            dict["gas"] += 1;
				        }else if (fueltype== "OilGeneration"){
				            var icon = {
				                url: 'images/oil.png',
				                scaledSize : new google.maps.Size(40, 40),
				            };
				            dict["oil"] += 1;
				        }else{
				            var icon = {
				                url: 'images/solar.png', 
				                scaledSize : new google.maps.Size(40, 40),
				            };
				            dict["solar"] += 1;
				        }
				        if (markerdict.has(obj.coors.lat)){
				        	var v = markerdict.get(obj.coors.lat);
				        	v.push(name);
				        	markerdict.set(obj.coors.lat, v);
				        }else{
				        	markerdict.set(obj.coors.lat, [name]);
				        	
				        	latLng.set(obj.coors.lat, [obj.coors.lng, icon]);
				        	}
			        }
			
				    for (var [key, value] of latLng.entries()) {
				    	createMarker(key, value, markerdict);
					      
				    }
			
					searchBatteryCoord(batterylist);	
				    });
				    }
				function createMarker(key, value, markerdict){
					var marker = new google.maps.Marker({
			            position: new google.maps.LatLng(key, value[0]),
			            map: map,
			            icon: value[1]
			          });
					marker.addListener('click', function(){
						_content = setMarkerMenu(markerdict.get(key));
						infowindow.setContent(_content);
						infowindow.open(map, this);
					});
			        markers.push(marker);
				}
				
				function drawBattery() 	{
					document.getElementById("run-btn").disabled = true;
					document.getElementById("loader").style.display = "block";
					scenario = document.getElementById("scenarioTxt").value;
					if (scenario == ''){
						scenario = "testBatt1"; //fixed temporarily, will be changed along with user input
					}
					var batteryjson= {}
					batteryjson["electricalnetwork"] = electricalnetwork;
					batteryjson["BatteryCatalog"] = batIRI;
					batteryjson["RenewableEnergyGenerator"] = pvGenIRI;
					var agenturl = prefix + '/JPS_ESS/ESSAgent';  
				
					var batteryurl = createUrlForAgent(scenario, agenturl, batteryjson);
					console.log(batteryurl);
				    var request = $.ajax({
				        url: batteryurl,
				        type: 'GET',
				        data: batteryjson,
				        contentType: 'application/json; charset=utf-8',
				        success: function(){  
				        },
				        error: function(ts) {
				            alert(ts.responseText);
				        }   
				    });
				    request.done( function(data) {
				        console.log ("success create request");
				        batterylist = JSON.parse(data).batterylist;
				        console.log(batterylist);
						drawMarkers();
						drawLines();
			
					});
			
			
				}
				function searchBatteryCoord(srcdata) {
			    		var size=srcdata.length; 
			    		console.log(size);
			    		console.log(srcdata);
			    		var x;
			    		var markerdict = new Map();
			    	    for (x=0; x< size; x++){
			    	    	createBattery(srcdata[x][0], srcdata[x][2], srcdata[x][1]);
			    	       }
			
						document.getElementById("loader").style.display = "none";
						document.getElementById("run-btn").disabled = false;
				}
				function createBattery(iri, lat, lng){//to be integrated with createMarker once variables have been commonified. 
					var marker = new google.maps.Marker({
			            position: new google.maps.LatLng(String(lat), String(lng)),
			            map: map,
			            title: String(iri),
			            icon: "images/battery.png"
			          });
					marker.addListener('click', function(){
			        	var jsonArray = marker.title.split('/');
			        	console.log(jsonArray);
			        	var spec = marker.title + '#' + jsonArray[jsonArray.length-1];
						_content = setMarkerMenu([spec]);
						infowindow.setContent(_content);
						infowindow.open(map, this);
					});
			        markers.push(marker);
				}
			
				function calLengthOfLine(x1,x2,y1,y2) {
			
					return (x1 - x2)(x1 - x2) + (y1 - y2)(y1 - y2)
				}
				function clearMarkers() {
			        if(!markers){
			            return;
			        }
			        for(marker of markers){
			            marker.setMap(null);
			            marker=null;
			        }
			    }
				function constructLineMenu(id,callback)
				{
					// var url = 'http://www.theworldavatar.com/kb/sgp/jurongisland/jurongislandpowernetwork' + id;
					selectedId = id.split('/')[1];
					// sendRequest(url,function (response) {
			    var promise1 = new Promise(function (resolve, reject){
			        resolve(openWindowLineAndBus('http://www.jparksimulator.com/kb/sgp/jurongisland/jurongislandpowernetwork/' + selectedId +'#'+selectedId.split('.')[0], branchInfo, callback));
			    }); 
			    promise1.catch(alert);
				}
			
			
			
				function setKMLMenu(kmlEvent)
				{
					var data = kmlEvent.featureData;
					var nameString = data.name.substr(1);
					console.log(nameString);
					var names = nameString.split('[');
					var buttonsList = '<p>Please select the Entity you would like to modify</p>';
					console.log(buttonsList);
					for(var index in names)
					{
						var name = names[index];
			
						 buttonsList = buttonsList + '<div><label>' + name.split('#')[1] + '</label>' +
							'<button onclick="selectEBus(event)" style= "cursor: pointer;" id="' + name + '"> > </span></div>'
					}
			
					buttonsList = '<div id="buttonContainer">'+ buttonsList +'</div><hr/><div id="inputsContainer"></div>';
					// set the content of the popup window.
					kmlEvent.featureData.infoWindowHtml = '<div>' + buttonsList + '</div>';
			
				}
				
				function setMarkerMenu(jsonArray)
				{
					var buttonsList = '<p>Please select the Entity you would like to modify</p>';
					console.log(jsonArray);
					for(var index in jsonArray)
					{
						var name = jsonArray[index];
						console.log(name);
						 buttonsList = buttonsList + '<div><label>'  + name.split('#')[1] + '</label>'+
							'<button onclick="selectEBus(event)" style= "cursor: pointer;" id="' + name + '"> > </span></div>'
					}
			
					buttonsList = '<div id="buttonContainer">'+ buttonsList +'</div><hr/><div id="inputsContainer"></div>';
					// set the content of the popup window.
					infoWindowHtml = '<div>' + buttonsList + '</div>';
			
					console.log(infoWindowHtml);
					return infoWindowHtml;
			
				}
			
				function selectEBus(event) {
				selectedId =  event.srcElement.id;
				openWindow(selectedId);
			}
			
			function openWindow(selectedId){
				if (selectedId.includes("Bus")){
					openWindowLineAndBus(selectedId, busInfo);
				}else if (selectedId.includes('VRB')){
					openWindowLineAndBus(selectedId, batteryInfo);
				}
				else if (selectedId.includes("ine")){
					//recreate infowindow if present. 
					openWindowLineAndBus(selectedId, branchInfo);
				}
				else{
					openWindowGen(selectedId);
				}
				
			}
			function openWindowGen(id){
			 //since geninfo too large for request header, I'll split it up
				selectedId =  id; //this needs to be saved on a local version, and not towards here. 
				var kmljson = {};
				kmljson["sparqlquery"] = genInfo;
				kmljson["scenarioresource"] = selectedId.split('#')[0];
				var inputsHTML = '';
				var kmlurl = prefix + '/jps/scenario/'+scenario+'/query?query=' + encodeURIComponent(JSON.stringify(kmljson));
				kmljson["sparqlquery"] = genInfo2;
				var kmlurl2 = prefix +'/jps/scenario/'+scenario+'/query?query=' + encodeURIComponent(JSON.stringify(kmljson));
				console.log(kmlurl);
				console.log(kmlurl2);
				$.when(
					$.ajax({
					url: kmlurl,
					type: 'GET',
					contentType: 'application/json; charset=utf-8',
					success: function(data){ 
						var obj0 = JSON.parse(data);
						obj1 = obj0['results']['bindings'][0];
					},
					error: function(ts) {
						alert(ts.responseText);
					}   
					 }),
				
					$.ajax({
					url: kmlurl2,
					type: 'GET',
					contentType: 'application/json; charset=utf-8',
					success: function(data){   
						var obj0 = JSON.parse(data);
						console.log(obj0);
						obj2 = obj0['results']['bindings'][0];
						console.log(obj2);
					},
					error: function(ts) {
						alert(ts.responseText);
					}   
				})).then( function(){
					var obj0 = Object.assign(obj1, obj2);
					console.log(obj0,obj1, obj2)
					var result = Object.keys(obj0).map(function(key) {return [key, obj0[key]];});
					nameSet = [];
					console.log(selectedId);
					var owlName = selectedId.split('#')[1].split('.')[0];
					for(var item in result)
					{
						var pair = result[item];
						if (pair[0] == "entity"){}
						else if(!pair[1]['value'].includes('.owl')) //this is for values only. 
						{
							if (owlName.includes('.')){
								owlName = owlName.split('.')[0]
								}
							var inputLine = '<tr><td><label>' + pair[0]+"_" +owlName +'</label></td><td><input class="input_class" data-dataType="' + pair[1]['datatype'] + '" value="' + pair[1]['value'] + '" style="float: right;"></td></tr>';
							inputsHTML = inputsHTML + inputLine;
							nameSet.push(pair[0]);
						}else {
							//for units, just place below the box. 
							//remove the last 
							inputsHTML = inputsHTML.slice(0, -10)
							//add in the units 
							var inputLine = '</td><td><input class="input_class" data-dataType="' + pair[1]['datatype'] + '" value="' + pair[1]['value'].split('#')[1] + '" style="float: right;" disabled="disabled"> </td><td> </td></tr>';
							inputsHTML = inputsHTML + inputLine;
						}
					}
			
					console.log(inputsHTML);
					var div = document.getElementById('inputsContainer');
					div.innerHTML = '<table data-type="kml" data-url='+ selectedId +' id="inputsTable">' + inputsHTML + '</table><br/><button onclick="SubmitTable(this)">OPF</button>'+
					'<img id="myProgressBar" style="width:100px;height:100px;display:none" src="https://media.giphy.com/media/3oEjI6SIIHBdRxXI40/giphy.gif"/><br/>'
			
			
				}, function (jqXHR, textStatus, errorThrown){
					console.log(textStatus);
					console.log(errorThrown);
				}
				);
			}
			function openWindowLineAndBus(id, type, callback){ //gen has its own openWindow cos it's too large. 
				var kmlurl = createUrlForSparqlQuery(scenario, id.split('#')[0], type);
				console.log(kmlurl);
				var inputsHTML = '';
				var request = $.ajax({
					url: kmlurl,
					type: 'GET',
					contentType: 'application/json; charset=utf-8',
					success: function(){  
					},
					error: function(ts) {
						alert(ts.responseText);
					}   
				});
				request.done( function(data) {
					var obj0 = JSON.parse(data);
					obj0 = obj0['results']['bindings'][0];
					console.log(obj0)
			
			
					var result = Object.keys(obj0).map(function(key) {return [key, obj0[key]];});
					nameSet = [];
					var owlName = id.split('#')[1];
					for(var item in result)
					{
						var pair = result[item];
						if (pair[0] == "entity"){}
						else if(!pair[1]['value'].includes('.owl')) //this is for values only. 
						{	console.log(owlName);
							if (owlName.includes('.')){
								owlName = owlName.split('.')[0];
							}
							var inputLine = '<tr><td><label>' + pair[0]+"_" +owlName +'</label></td><td><input class="input_class" data-dataType="' + pair[1]['datatype'] + '" value="' + pair[1]['value'] + '" style="float: right;"></td></tr>';
							inputsHTML = inputsHTML + inputLine;
							nameSet.push(pair[0]);
						}else {
							//for units, just place below the box. 
							//remove the last 
							inputsHTML = inputsHTML.slice(0, -10)
							//add in the units 
							var inputLine = '</td><td><input class="input_class" data-dataType="' + pair[1]['datatype'] + '" value="' + pair[1]['value'].split('#')[1] + '" style="float: right;" disabled="disabled"> </td><td> </td></tr>';
							inputsHTML = inputsHTML + inputLine;
						}
					}
			
					console.log(inputsHTML); 
					if ((id.includes("Bus")) || (id.includes("VRB")) || (id.includes("PV"))){
					
						var div = document.getElementById('inputsContainer');
						div.innerHTML = '<table data-type="kml" data-url='+ selectedId +' id="inputsTable">' + inputsHTML + '</table><br/><button onclick="SubmitTable(this)">OPF</button>'+
						'<img id="myProgressBar" style="width:100px;height:100px;display:none" src="https://media.giphy.com/media/3oEjI6SIIHBdRxXI40/giphy.gif"/><br/>'
						}
						
						else if (callback == null){
							innerHTML = '<table data-type="line" data-url='+ selectedId +' id="inputsTable">' + inputsHTML + '</table><br/><button onclick="SubmitTable(this)">OPF</button>'+
									'<img id="myProgressBar" style="width:100px;height:100px;display:none" src="https://media.giphy.com/media/3oEjI6SIIHBdRxXI40/giphy.gif"/><br/>';
							infoWindow.setContent(innerHTML);
						}
						
						else{
							const newPromise = new Promise((resolve, reject) => {
								resolve('Success');
						});
							newPromise.then((successMessage) => {
								innerHTML = '<table data-type="line" data-url='+ selectedId +' id="inputsTable">' + inputsHTML + '</table><br/><button onclick="SubmitTable(this)">OPF</button>'+
									'<img id="myProgressBar" style="width:100px;height:100px;display:none" src="https://media.giphy.com/media/3oEjI6SIIHBdRxXI40/giphy.gif"/><br/>';
								console.log(innerHTML);
								callback(innerHTML);
							});
						}
			
				});
			
			}
			function SubmitTable(e) {
			
				opt = e.innerHTML;
				var table = document.getElementById('inputsTable');
				var rows = table.firstElementChild.childNodes;
				var url = table.getAttribute('data-url');
				var type = table.getAttribute('data-type');
				console.log('type',type);
			
				var JSONArray  = {};
			
				var proceed = true;
				console.log(rows.length, 'Rows length');
				for(var i = 0; i < rows.length; i++)
				{
					var row = rows[i];
					var name = row.getElementsByTagName('label')[0].innerText;
					var value = row.getElementsByTagName('input')[0].value;
					
					
					if(name.includes('EBus-001')){ // This is a slack bus, the magnitude is always 1 and the angle is always 0
						//console.log("label forbidden= "+label);
						if(name.includes('VoltageMagnitude')|| name.includes('Vm_EBus')) {
							if (value !== 1){
								alert('The value of the voltage magnitude and Vm for a slack bus should always be 1 kV (in p.u format)')
								proceed = false;
							}
						}
						
						if (name.includes('VoltageAngle')|| name.includes('Va_EBus')){
							if (value !== 0){
								alert('The value of the voltage angle and Va for a slack bus should always be 0 degree')
								proceed = false;
							}
						}
					}
					else{ // This is a load bus 
					//console.log("label forbidden= "+label);
						if(name.includes('VoltageMagnitude')|| name.includes('Vm_EBus')){
							if( value > 1.05 || value <= 0.95){
								alert('The value of the voltage magnitude and Vm should be between 0.95 and 1.05 kV (in p.u format)')
								proceed = false;
							}
						}           
					}
					
					
					
					
					
			
					
					var datatype = row.getElementsByTagName('input')[0].getAttribute('data-dataType');
					console.log('value',value,'name',name,'url',url);
					JSONArray[name] = {name: name,value:value, datatype: datatype }
				}
			
			
			
				if(proceed){
					var progress = document.getElementById('myProgressBar');
					progress.style.display = 'block';
					updateOwlFile(url,JSONArray,type);
				}
			
			
			}
			function updateOwlFile(filename,JSONArray,_type) {
			
				console.log('number',Object.keys(JSONArray).length);
				console.log('JSONArray',Object.keys(JSONArray));
				console.log('filename=',filename);
				console.log('type=',_type);
			
				var allItemsArray = [];
				var indexCounter = 0;
				var temp = [];
				for(var item in JSONArray){
						if(((indexCounter!== 0) && (indexCounter % 10 === 0))||(indexCounter === parseInt(Object.keys(JSONArray).length - 1)))
						{
							if((indexCounter === parseInt(Object.keys(JSONArray).length - 1)))
							{
								//allItemsArray.push(temp);
								//temp = [];
								console.log('yes');
								allItemsArray.push(temp);
								temp = [];
								temp.push(item)
							}
							else
							{   console.log('nononon');
								allItemsArray.push(temp);
								temp = [];
								temp.push(item)
							}
			
			
						}
						else
						{   console.log('yeah');
							temp.push(item)
						}
			
						console.log(indexCounter);
						console.log(item)
						indexCounter++;
					}
			
				console.log(allItemsArray);
			
			
				var asyncLoop = function(o){
					var i=-1,
						length = o.length;
						console.log(o);
						console.log(length);
					var loop = function(){
						i++;
						console.log(i);
						if(i===length){
							console.log("CALLBACK called? ");
							o.callback(); 
							return;
						}
						o.functionToLoop(loop, i);
					};
					loop();//init
			};
			
			
			asyncLoop({
				length : Math.ceil(Object.keys(JSONArray).length / 10),
				functionToLoop : function(loop, i){
			
			
					var sampleUpdate = [];
					var uri = [];
			
					var Session = allItemsArray[i];
					console.log(length);
					console.log('Session',Session);
			
					for(var j = 0; j < Session.length; j++)
					{
						var item = Session[j];
						var obj = JSONArray[item];
						var targetIRI = obj.name;
						var dataType = obj.datatype;
						if(dataType === 'int')
						{
							dataType = 'integer'
						}
						console.log('dataType',dataType);
						var base = filename.split('#')[0] + '#';
						base = base.replace('/OntoEN','');
						base=base.replace('theworldavatar','jparksimulator'); //because in electrical it use jparksimulator instead of theworldavatar
						var value = obj.value;
						if(targetIRI)
						{
			
							if (targetIRI.includes("Costn1")){
								targetIRI = targetIRI.replace("Costn1","Costn-1" );
								
								console.log(targetIRI);
							}else if (targetIRI.includes("Costn2")){
								targetIRI = targetIRI.replace("Costn2","Costn-2" );
								
								console.log(typeof targetIRI);
							}
							var deleteUpdate = "DELETE WHERE {<" + base + targetIRI + "> <http://www.theworldavatar.com/ontology/ontocape/upper_level/system.owl#numericalValue> " + "?o.}";
							var insertUpdate = "INSERT DATA {<" + base + targetIRI + "> <http://www.theworldavatar.com/ontology/ontocape/upper_level/system.owl#numericalValue> " +value +".}";
								
								
			
							console.log('deleteUpdate',deleteUpdate);
							console.log('insertUpdate',insertUpdate);
			
							sampleUpdate.push(deleteUpdate);
							sampleUpdate.push(insertUpdate);
							
							uri.push(filename);
							uri.push(filename);
							
						}
					}
					console.log(scenario);
					console.log(sampleUpdate); 
					var myUrl = createUrlForSparqlUpdate(scenario,base.split('#')[0], sampleUpdate.join(';'));
					var request = $.ajax({
						url: myUrl,
						type: 'GET',
						contentType: 'application/json; charset=utf-8'
					});
					console.log(myUrl);
					request.done(function(data) {
						console.log('data received', data);
						loop();
			
			
					});
			
					request.fail(function(jqXHR, textStatus) {
						// your failure code here
					});
			
			
				},
				callback : function(){
						document.getElementById("loader").style.display = "block";
						var agenturl = prefix + '/JPS_POWSYS/ENAgent/startsimulation'+opt; //call upon battery simulation rather than OPF/PF
						data = { "electricalnetwork":electricalnetwork}
						url = createUrlForAgent(scenario, agenturl, data);
						console.log(url);
						var delayInMilliseconds = 10000; //1 second
			
						setTimeout(function() {
							console.log('timeout');
						}, delayInMilliseconds);
						
					var request = $.ajax({
						url: url,
						type: 'GET',
						contentType: 'application/json; charset=utf-8'
					});
			
					request.done(function(){
						json = { "electricalnetwork":electricalnetwork ,"flag": scenario };
						console.log('DONE SIMULATION');
						openWindow(filename);
						draw
			            document.getElementById("loader").style.display = "none";
					});
			
			
				}
			});
			}
			function animateCircle(line,timeOut) {
					var count = 0;
					window.setInterval(function() {
						count = (count + 1) % 200;
			
						var icons = line.get('icons');
						icons[0].offset = (count / 2) + '%';
						line.set('icons', icons);
					}, timeOut);
				}
			function clearAnimatedLines(){
				animatedLines.forEach((line)=>
				{
					line.setMap(null);
				})
				animatedLines=[];
			}
				function createUrlForSparqlUpdate(scenarioname, iri, sparql) {
			
					var url2 = prefix + '/jps/scenario/' + scenarioname + '/update?query=';
					urljson = {"scenarioresource":iri,"sparqlupdate":sparql};
					url2 += encodeURIComponent(JSON.stringify(urljson)); 
					//url2 += JSON.stringify(urljson); 
					return url2;    
				}
			function createUrlForSparqlQuery(scenarioname, iri, sparql) {
					var url2 = prefix + '/jps/scenario/' + scenarioname + '/query?query=';
					urljson = {"scenarioresource":iri,"sparqlquery":sparql};
					url2 += encodeURIComponent(JSON.stringify(urljson)); 
					//url2 += JSON.stringify(urljson); 
					return url2;    
				}
			function createUrlForAgent(scenarioname, agenturl, agentparams) {
			
					var url;
					if ((scenarioname == null) || scenarioname == "base") {
						url = agenturl;
					} else {
						agentparams['scenarioagentoperation'] = agenturl;
						var scenariourl = prefix + '/jps/scenario/' + scenarioname + '/call';
						url = scenariourl;
					}
			
					return url + "?query=" + encodeURIComponent(JSON.stringify(agentparams));
				}
			
		</script>
		<script async defer
			src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBgm3-eMQauJ_dW4Cq66Hg9aP50jpp24rA&callback=initMap"></script>
	</body>
</html>


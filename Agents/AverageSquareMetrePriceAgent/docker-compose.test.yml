version: '3.8'

services:
  avgsqmprice_agent_test:
    image: ghcr.io/cambridge-cares/avgsqmprice_agent_test:1.0.0-SNAPSHOT
    container_name: avgsqmprice_agent_test
    environment:
      LOG4J_FORMAT_MSG_NO_LOOKUPS: "true"
    build:
      context: .
      target: prod
    ports:
      - 7000:5000
    extra_hosts:
      - host.docker.internal:host-gateway
    env_file:
      - ./tests/agent_test.env
    # NOTE below entrypoint overrides the default entrypoint in the Dockerfile
    # --preload flag is added to provide more information in the container to help with debugging
    entrypoint: ["gunicorn", "--bind", "0.0.0.0:5000", "avgsqmpriceagent:create_app()", "--preload"]

  # Blazegraph
  blazegraph_agent_test:
    image: docker.cmclinnovations.com/blazegraph:1.0.0-SNAPSHOT
    container_name: blazegraph_agent_test
    ports:
      - 27149:8080

  # PostgreSQL
  postgres_agent_test:
    container_name: postgres_agent_test
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    image: postgres:13.3
    restart: unless-stopped
    ports:
      - 7432:5432

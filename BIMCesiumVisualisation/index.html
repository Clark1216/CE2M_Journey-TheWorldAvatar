<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <link href='https://fonts.googleapis.com/css?family=Open Sans' rel='stylesheet'>

  <!-- Include the CesiumJS JavaScript and CSS files -->
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.95/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.95/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <style>
    .panel {
      display: block;
      position: absolute;
      padding: 2px 8px;
      top: 15px;
      left: 15px;
      background-color: rgba(38, 38, 38, 0.95);
      color: white;
      font-size: 14px;
      font-family: 'Open Sans';
    }

    .backdrop {
      display: none;
      position: absolute;
      bottom: 0;
      left: 0;
      pointer-events: none;
      padding: 8px;
      background-color: rgba(38, 38, 38, 0.95);
      font-size: 14px;
      font-family: 'Open Sans';
      color: white;
      border: 1px solid #444;
    }

    .biminfobox {
      display: none;
      position: absolute;
      top: 60px;
      right: 15px;
      max-width: 480px;
      pointer-events: none;
      background-color: rgba(38, 38, 38, 0.95);
      white-space: pre-line;
      font-size: 16px;
      font-family: 'Open Sans';
      color: white;
      border-radius: 4px;
      border: 1px solid #444;
      box-shadow: 0 0 10px 1px #000;
    }

    .biminfobox-title {
      display: block;
      height: 20px;
      padding: 10px 8px;
      background: rgba(84, 84, 84, 1);
      text-overflow: ellipsis;
      white-space: nowrap;
      overflow: hidden;
      box-sizing: content-box;
      border-top-left-radius: 4px;
      border-top-right-radius: 4px;
    }

    .biminfobox h3 {
      margin: 0px;
      padding: 0px;
      font-size: 18px;
    }

    .biminfobox-content {
      padding: 4px 10px;
      width: 100%;
    }

    #bim-infobox-table td {
      vertical-align: middle;
      text-align: left;
      padding: 4px 8px;
      border-top: 1px solid rgba(38, 38, 38, 0.95);
    }

    #bim-infobox-table tr:last-child {
      border-bottom: 1px solid rgba(38, 38, 38, 0.95);
    }

    #bim-infobox-table table {
      background-color: rgba(84, 84, 84, 0.8);
    }

    #bim-infobox-table tr:nth-child(odd) {
      background-color: rgba(84, 84, 84, 0.25);
    }

    #close {
      display: none;
      position:absolute;
      top:75px;
      right: 30px;
      background: transparent;
      border: none;
      border-radius: 2px;
      font-weight: bold;
      font-size: 16px;
      padding: 0 5px;
      margin: 0;
      color: white;
    }
    #close:focus {
      background: rgba(238, 136, 0, 0.44);
      outline: none;
    }
    #close:hover {
      background: #888;
      color: #000;
    }
    #close:active {
      background: #a00;
      color: #000;
    } 
  </style>
</head>

<body>
  <div id="cesiumContainer"></div>
  <div class="panel">
    <label for="toggleFeature"> Show/Hide roof and ceiling</label>
    <input type="checkbox" id="toggleFeature" onclick="hideFeature()"> 
  </div>
  <script>
    // Your access token can be found at: https://cesium.com/ion/tokens
    // Replace `your_access_token` with your Cesium ion access token
    Cesium.Ion.defaultAccessToken = 'your access token';

    /* <----------------------------- Functions -----------------------------> */
    /**
     * Add the tileset to the viewer and set its model matrix for geolocation
     * @param cesiumtileset   name of tileset.json file
     * @return                Cesium viewer primitive object
     */
    function addTileset(cesiumtileset) {
      var tile_fpath = "./ifcto3Dtilesnext/data/";
      coordinates = Cesium.Cartesian3.fromDegrees(103.77398, 1.30411, 0);

      return viewer.scene.primitives.add(
        new Cesium.Cesium3DTileset({
          url: tile_fpath.concat(cesiumtileset),
          modelMatrix: Cesium.Transforms.eastNorthUpToFixedFrame(coordinates),
          debugShowBoundingVolume: false,
        })
      )
    }

    // Show or hide the ceiling depending on checkbox input
    function hideFeature() {
      var checkBox = document.getElementById("toggleFeature");
      if (checkBox.checked == true) {
        tileset_ceiling.show = false;
      } else {
        tileset_ceiling.show = true;
      }
    }

    // Close the metadata infobox on click
    function closeMetadata() {
      const metadataBox = document.getElementsByClassName("biminfobox")[0];
      // Set transition time and effects for metadata infobox
      window.setTimeout(function () {
        metadataBox.style.transform = 'translate(100%, 0)';
        metadataBox.style.opacity = 0;
        metadataBox.style.visibility = 'hidden';
        metadataBox.style.transition = "visibility 0s 0.2s, opacity 0.2s ease-in, transform 0.2s ease-in";

        // Remove close button at same time
        closeElement.style.display = 'none';
      }, 0.2);
    }

    /**
     * Generates a formatted HTML string containing the picked feature's available metadata
     * @param metadata  the object referencing the picked feature's metadata stored in tileset
     * @return          HTML string
     */
    function createMetadataHtml(metadata) {
      const propertyKeys = metadata.getPropertyIds();
      if (!Cesium.defined(propertyKeys)) {
        return `(No properties for ${title})<br>`;
      }
      // Formatting the information box into a table
      let html = "<div class='biminfobox-title'>"
      let htmlTable = "<table id='bim-infobox-table' class='biminfobox-content' style='border-collapse:collapse;'>";

      for (let i = 0; i < propertyKeys.length; i++) {
        const propertyKey = propertyKeys[i];
        const propertyValue = metadata.getProperty(propertyKey);
        if (propertyKey == "Asset Name") {
          html += `<h3>${propertyValue}</h3>`;
        } else {
          htmlTable += `<tr><td>${propertyKey} :</td> <td> ${propertyValue}</td></tr>`;
        }
      }
      html += "</div>" + htmlTable + "</table>";
      return html;
    }

    /*<----------------------------- Script Content -----------------------------> */
    // Create a new viewer object
    const viewer = new Cesium.Viewer("cesiumContainer");

    /* Add new HTML elements */
    // Creating a metadata overlay element when mouse moves over an asset
    const promptOverlay = document.createElement("div");
    viewer.container.appendChild(promptOverlay);
    promptOverlay.className = "backdrop";

    // Create a custom infobox element to present meta data when clicked on an asset
    const metadataBox = document.createElement("div");
    viewer.container.appendChild(metadataBox);
    metadataBox.className = "biminfobox";
    
    // Create a close button for the infobox
    const closeElement = document.createElement("INPUT");
    closeElement.id="close";
    closeElement.setAttribute("type", "button");
    closeElement.value="X";
    closeElement.onclick=closeMetadata;
    viewer.container.appendChild(closeElement);

    // Add tilesets to the viewer
    const tileset_bim = addTileset("tileset_bim.json");
    const tileset_ceiling = addTileset("tileset_ceiling.json");

    // Zoom to the tileset, with a small offset so that it is fully visible
    const offset = new Cesium.HeadingPitchRange(
      Cesium.Math.toRadians(-45.0),
      Cesium.Math.toRadians(-45.0),
      80.0
    );
    viewer.zoomTo(tileset_bim, offset);

    // Setting up for any event input on the cesium viewer screen
    const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);

    // Creating actions for mouse-over input
    handler.setInputAction(function (movement) {
      let overlayText = "";

      // Create an object for the picked feature to retrieve the metadata stored in tileset
      const pickedFeature = viewer.scene.pick(movement.endPosition);
      const contentMetadata = pickedFeature?.content?.metadata;

      // If there is metadata for the asset
      if (Cesium.defined(contentMetadata)) {
        // display a prompt to click for more information
        promptOverlay.style.display = "block";
        promptOverlay.style.bottom = `${viewer.canvas.clientHeight - movement.endPosition.y}px`;
        promptOverlay.style.left = `${movement.endPosition.x}px`;
        promptOverlay.innerHTML = "Information available for "+contentMetadata.getProperty("Asset Name")+" - <b style ='font-size: 16px'>CLICK</b> for more details";

        // display the metadata information in a custom infoBox when clicked
        handler.setInputAction(function (movement) {
          // Display the infobox       
          metadataBox.style.display = "block";
          // Set transition time and effects
          window.setTimeout(function () {
            metadataBox.style.transform = 'translate(0, 0)';
            metadataBox.style.opacity = 1;
            metadataBox.style.visibility = 'visible';
            metadataBox.style.transition = "opacity 0.2s ease-out, transform 0.2s ease-out";

            // Display the close button at same time of transition
            closeElement.style.display = "block";
          }, 0.2);
          // Text input for metadata info box
          overlayText += createMetadataHtml(contentMetadata);
          metadataBox.innerHTML = overlayText;
        }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

      } else {
        // do not display the mouse-over prompt
        promptOverlay.style.display = "none";

        // Add a empty left click handler when picked feature has no meta data
        // Without this empty handler, the UI for clicking becomes problematic
        handler.setInputAction(function (movement) {
        }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
      }
    }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);


  </script>
</body>

</html>
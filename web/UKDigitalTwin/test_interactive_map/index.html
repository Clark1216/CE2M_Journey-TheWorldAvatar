<!DOCTYPE html>
<html>

<head>
    <title>Power System Visualisation</title>
    <meta charset="utf-8">

    <!-- Javascript -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.4.1/mapbox-gl.js"></script>
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js'></script>
    <script src='http://kg.cmclinnovations.com:81/user/themes/quark/js/checktree.js'></script>
    <script src='http://kg.cmclinnovations.com:81/user/themes/quark/js/mapbox-controls.js'></script>
    <script src='http://kg.cmclinnovations.com:81/user/themes/quark/js/side-panel.js'></script>
    <!--<script src="https://cdn.bootcss.com/Turf.js/5.1.6/turf.min.js"></script>-->
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <script src='power-system.js'></script>
    <script src='selectBus.js'></script>

    <!-- Stylesheets -->
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.4.1/mapbox-gl.css' rel='stylesheet'>
    <link href='http://kg.cmclinnovations.com:81/user/themes/quark/css/mapbox-controls.css' rel='stylesheet' />
    <link href='http://kg.cmclinnovations.com:81/user/themes/quark/css/side-panel.css' rel='stylesheet' />
    <!--<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
          integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
          crossorigin="" />-->
    <link href='style.css' rel='stylesheet' />

</head>

<body>

    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

    <!-- div is a DOM element -->
    <div id='map'></div>
    <div id="tiltShift"></div>
    <div id="controlsParent"></div>

    <script>
        // The getControls() is invoked from the mapbox-controls.js for returning a controlHTML containing camera, terrain, and layer panels
        document.getElementById("controlsParent").innerHTML = getControls();

        // Initial state of side-panel (from side-panel.js)
        initialiseSidePanel(document.getElementById("map"));

        // Reset side panel (from power-system.js)
        resetSidePanel();

        // Show loading icon whilst stuff spins up
        //var loadingHTML = `
        //        <br><br><br><br><br>
        //        <img width='150' src='loading.gif'></img>
        //        <br>
        //        <span style='color: grey; font-style: italic;'>Loading data, please wait...</span>
        //    `;
        //appendSidePanelText(loadingHTML);

        // Initialise the MapBox map
        mapboxgl.accessToken = 'pk.eyJ1Ijoiam1hcnNkZW4iLCJhIjoiY2ttZzNqM3IxM2JyYzJ2bndzZnIxeG1lciJ9.uwb9ZnBO3vWssvcBsXcFeA';
        var map = new mapboxgl.Map(getDefaultMapOptions());

        // Initialise MapBox popup for mouse-overs
        var popup = new mapboxgl.Popup({
            closeButton: false,
            closeOnClick: false
        });

        // Change some layer colors depending on selected style
        var inner_text = '#3E3E3E';
        var outer_text = '#FFFFFF';

        // Triggers after terrain change
        function terrainCallback(terrainType) {
            if (terrainType === "light") {
                inner_text = '#3E3E3E';
                outer_text = '#FFFFFF';
            } else {
                inner_text = '#FFFFFF';
                outer_text = '#000000';
            }
        }

        // Triggers after camera change
        function cameraCallback() {
            popup.remove();
            resetSidePanel();
        }

        // Hide or show a layer
        function toggleLayer(layerID, enabled) {
            map.setLayoutProperty(
                layerID,
                "visibility",
                (enabled ? "visible" : "none")
            );
        }

        // Triggered after layer change
        function layerCallback(layerID, enabled) {
            if (enabled && layerID.includes("power_")) {
                // Show the power layers
                toggleLayer("power_locations", true);
                toggleLayer("power_labels", true);

                // Hide the SDG layers
                toggleLayer("sdg_locations", false);
                toggleLayer("sdg_labels", false);

                // Hide the consumption layers
                toggleLayer("Electricity_Consumption_region_borders", false);
                toggleLayer("Electricity_Consumption_area_fill", false);
                toggleLayer("Electricity_Consumption_area_borders", false);

                //Hide the model layers
                toggleLayer("Model_EBus_GPSLocation", false);
                toggleLayer("Model_Branch_GPS_Points", false);
                toggleLayer("Model_Animated_Branch_Arrow", false);
            }

            if (enabled && layerID.includes("sdg_")) {
                // Show the SDG layers
                toggleLayer("sdg_locations", true);
                toggleLayer("sdg_labels", true);

                // Hide the power layers
                toggleLayer("power_locations", false);
                toggleLayer("power_labels", false);

                // Hide the consumption layers
                toggleLayer("Electricity_Consumption_region_borders", false);
                toggleLayer("Electricity_Consumption_area_fill", false);
                toggleLayer("Electricity_Consumption_area_borders", false);

                //Hide the model layers
                toggleLayer("Model_EBus_GPSLocation", false);
                toggleLayer("Model_Branch_GPS_Points", false);
                toggleLayer("Model_Animated_Branch_Arrow", false);
            }

            if (enabled && layerID.includes("Electricity_")) {
                // Show the consumption layers
                toggleLayer("Electricity_Consumption_region_borders", true);
                toggleLayer("Electricity_Consumption_area_fill", true);
                toggleLayer("Electricity_Consumption_area_borders", true);

                // Hide the power layers
                toggleLayer("power_locations", false);
                toggleLayer("power_labels", false);

                // Hide the SDG layers
                toggleLayer("sdg_locations", false);
                toggleLayer("sdg_labels", false);

                //Hide the model layers
                toggleLayer("Model_EBus_GPSLocation", false);
                toggleLayer("Model_Branch_GPS_Points", false);
                toggleLayer("Model_Animated_Branch_Arrow", false);
            }

            // TODO: add new layer for visualising the model layer
            if (enabled && layerID.includes("Model_")) {
                // Show the model layers
                toggleLayer("Model_EBus_GPSLocation", true);
                toggleLayer("Model_Branch_GPS_Points", true);
                toggleLayer("Model_Animated_Branch_Arrow", true);

                // Hide the power layers
                toggleLayer("power_locations", false);
                toggleLayer("power_labels", false);

                // Hide the SDG layers
                toggleLayer("sdg_locations", false);
                toggleLayer("sdg_labels", false);

                // Hide the consumption layers
                toggleLayer("Electricity_Consumption_region_borders", false);
                toggleLayer("Electricity_Consumption_area_fill", false);
                toggleLayer("Electricity_Consumption_area_borders", false);

            }

            if (enabled) updateLegend(layerID);
        }

        // Setup map with mapbox-controls.js
        setup(map, cameraCallback, terrainCallback, layerCallback);


        // On initial load...
        map.on("load", function () {
            resetSidePanel();
            updateLegend("power_locations");
        });

        // Triggers whenever the terrain is changed, at this point MapBox
        // effectively generates a new map so we have to add everything again.
        map.on('style.load', function () {

            // Variable for area currently under mouse cursor
            // var hoveredStateId = null;

            console.log("INFO: New style has been loaded.");
            refresh();

            // ===== SOURCES ====
            // Add the powerplant data
            map.addSource('powerplants', {
                type: 'geojson',
                data: 'UK_PowerPlants.geojson'
            });

            // Add the region boundaries geoJSON source
            map.addSource('Electricity_Consumption_region', {
                type: 'geojson',
                data: 'UK_Electricity_Consumption_Regions.geojson'
            });

            // Add the sub areas boundaries geoJSON source
            map.addSource('Electricity_Consumption_area', {
                type: 'geojson',
                data: 'UK_Electricity_Consumption_Areas.geojson'
            });

            // Add the bus model parameter and GPS location geoJSON source
            map.addSource('Bus_model_GPS_Parameters', {
                type: 'geojson',
                data: 'UK_Grid_Model_Bus_Parameter.geojson'
            });

            // add the bus model input variables geojson source
            map.addSource('Bus_model_input_variables', {
                type: 'geojson',
                data: 'UK_Grid_Model_Bus_InputVar.geojson'
            });

            var counter = 0;
            // jquery for adding the geojson file for creating the animated arrow moving alongside the branch
            $.ajax({
                type: "get",
                url: "/UK_Grid_Model_Branch_GPSPoints.geojson",
                dataType: "json",
                success: function (data) {
                    console.log("querying the branch GPS locations succeeded.");
                    const steps = 200;
                    var Branch_GPSPoints = data;
                    for (i = 0; i < Branch_GPSPoints.features.length; i++) {
                        var arc = [];
                        var lineDistance = turf.lineDistance(Branch_GPSPoints.features[i], 'kilometers');
                        for (let j = 0; j <= lineDistance; j += lineDistance / steps) {
                            var segment = turf.along(Branch_GPSPoints.features[i], j, 'kilometers');
                            // console.log("*******Branch_GPSPoints.features[i] are: ", segment)
                            arc.push(segment.geometry.coordinates);
                        }
                        // Update the route with calculated arc coordinates
                        Branch_GPSPoints.features[i].geometry.coordinates = arc;
                    }
                    console.log("Branch_GPSPoints is updated by adding the arcs coordinates.", Branch_GPSPoints);
                   

                    map.addSource('Branch_GPSPoints', {
                        type: 'geojson',
                        data: Branch_GPSPoints
                    });

                    map.addLayer({
                        id: 'Model_Branch_GPS_Points',
                        type: 'line',
                        source: 'Branch_GPSPoints',
                        layout: {
                            "line-miter-limit": 2,
                            "line-join": "miter"
                        },
                        paint: {
                            "line-color": "#33C9EB",
                            "line-width": 4
                        }
                    });

                    $.ajax({
                        type: "get",
                        url: "/UK_Grid_Model_Branch_FromBus_GPSPoints.geojson",
                        dataType: "json",
                        success: function (r) {
                            var Branch_FromBus_GPS_Points = r;
                            // console.log("Branch_FromBus_GPS_Points are: ", Branch_FromBus_GPS_Points);
                            map.addSource('Branch_FromBus_GPS_Points', { // the fromBus GPS location of a branch
                                type: 'geojson',
                                data: Branch_FromBus_GPS_Points
                            });

                            // add the animated branch arrow
                            map.addLayer({
                                'id': 'Model_Animated_Branch_Arrow',
                                'type': 'symbol',
                                'source': 'Branch_FromBus_GPS_Points',
                                'layout': {
                                    'icon-image': 'arrow',
                                    'icon-size': 0.03,
                                    'icon-rotate': ['get', 'bearing'],
                                    'icon-rotation-alignment': 'map',
                                    'icon-allow-overlap': true,
                                    'icon-ignore-placement': true,
                                    'visibility': 'visible'
                                }
                            });

                            for (i = 0; i <= Branch_GPSPoints.features.length -1 ; i++) {
                                animate(i, -1, 1);
                                counter += 1;
                                console.log("The counter is: ", counter);
                            }
                            
                            function animate(featureIdx, cntr, timeOut) {
                                // Update point geometry to a new position based on counter denoting
                                // the index to access the arc.
                                console.log("The featureIdx is: ", featureIdx, "and cntr is: ", cntr);

                                window.setInterval(function () {
                                    cntr = (cntr + 1) % steps;
                                   
                                    Branch_FromBus_GPS_Points.features[featureIdx].geometry.coordinates = Branch_GPSPoints.features[featureIdx].geometry.coordinates[cntr];

                                    Branch_FromBus_GPS_Points.features[featureIdx].properties.bearing = turf.bearing(                                 
                                        turf.point(Branch_GPSPoints.features[featureIdx].geometry.coordinates[cntr >= steps-1 ? cntr - 1 : cntr]),
                                        turf.point(Branch_GPSPoints.features[featureIdx].geometry.coordinates[cntr >= steps-1 ? cntr : cntr + 1])
                                    );

                                    // Update the source with this new data.
                                    map.getSource('Branch_FromBus_GPS_Points').setData(Branch_FromBus_GPS_Points);

                                    // Request the next frame of animation so long the end has not been reached.
                                    //if (cntr < steps) {
                                    //    requestAnimationFrame(function () { animate(featureIdx, cntr + 1); });
                                    //}

                                }, timeOut);
                            }
                        }
                    
                    });

                },
                error: function () {
                    alert("Request failed.");
                }
            });

            map.loadImage('/bus.png', (error, image) => {
                if (error) throw error;
                map.addImage('EBus_icon', image);
            });

            map.loadImage('/arrow.png', (error, image) => {
                if (error) throw error;
                map.addImage('arrow', image);
            });

            // ===== SOURCES ====
        

            // ===== LAYERS =====

            // Labels for Electricity Buses
            map.addLayer({
                id: 'Model_EBus_GPSLocation',
                type: 'symbol',
                source: 'Bus_model_GPS_Parameters',
                layout: {
                    'icon-image': 'EBus_icon',
                    'icon-size': 0.075,
                    'text-field': ['get', 'Bus_num'],
                    'text-font': [
                        'Open Sans Semibold',
                        'Arial Unicode MS Bold'
                    ],
                    'text-offset': [0, 1.5],
                    'text-anchor': 'top'
                }
            });
            

            // Add the layer for visualising the regional boundaries with a mouse hover effect
            map.addLayer({
                'id': 'Electricity_Consumption_region_borders',
                'type': 'line',
                'source': 'Electricity_Consumption_region',
                'layout': {
                    'visibility': 'none'
                },
                'paint': {
                    'line-color': '#9ecae1',
                    'line-width': 1
                }
            });

            // Add the layer for visualising the filled sub areas with a mouse hover effect
            map.addLayer({
                'id': 'Electricity_Consumption_area_fill',
                'type': 'fill',
                'source': 'Electricity_Consumption_area',
                'layout': {
                    'visibility': 'none'
                },
                'paint': {
                    'fill-color': ["get", "area-color"],
                    'fill-opacity': [
                        'case',
                        ['boolean', ['feature-state', 'hover'], false],
                        1,
                        1
                    ]
                }
            });

            // Add the layer for visualising the border of sub areas
            map.addLayer({
                'id': 'Electricity_Consumption_area_borders',
                'type': 'line',
                'source': 'Electricity_Consumption_area', // reference the data source
                'layout': {
                    'visibility': 'none'
                },
                'paint': {
                    'line-color': '#9ecae1',
                    'line-width': 1
                }
            });

            // Locations for power generation
            map.addLayer({
                'id': 'power_locations',
                'type': 'circle',
                'source': 'powerplants',
                'layout': {
                    'visibility': 'visible'
                },
                'paint': {
                    'circle-radius': ["+", 3, ["*", 0.9, ["ln", ["to-number", ["get", "capacity"]]]]],
                    'circle-color': ["get", "marker-color"],
                    'circle-stroke-width': 1,
                    'circle-stroke-color': inner_text,
                }
            });

            // Labels for power generation
            map.addLayer({
                id: 'power_labels',
                type: 'symbol',
                source: 'powerplants',
                layout: {
                    'visibility': 'visible',
                    'text-field': ['concat',
                        ['get', 'name'],
                        '\n Capacity: ',
                        ['get', 'capacity'],
                        ' MW \n Fuel: ',
                        ['get', 'fuel'],
                        ' \n | \n | \n | \n | ']
                    ,
                    'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],
                    'text-size': 14,
                    'text-offset': [0, -4],
                },
                "paint": {
                    "text-color": inner_text,
                    "text-halo-color": outer_text,
                    "text-halo-width": 0.8,
                    "text-opacity": ['interpolate', ['exponential', 2], ['zoom'], 8, 0, 10, 1]
                }
            });

            // Locations for SDG indicators
            map.addLayer({
                'id': 'sdg_locations',
                'type': 'circle',
                'source': 'powerplants',
                'layout': {
                    'visibility': 'none'
                },
                'paint': {
                    'circle-radius': ["+", 3, ["*", 0.9, ["ln", ["to-number", ["get", "capacity"]]]]],
                    'circle-color': ["get", "sdgcolor"],
                    'circle-stroke-width': 1,
                    'circle-stroke-color': inner_text,
                }
            });

            // Labels for SDG indicators
            map.addLayer({
                id: 'sdg_labels',
                type: 'symbol',
                source: 'powerplants',
                layout: {
                    'visibility': 'none',
                    'text-field': ['concat',
                        ['get', 'name'],
                        '\n Capacity: ',
                        ['get', 'capacity'],
                        ' MW \n Fuel: ',
                        ['get', 'fuel'],
                        ' \n | \n | \n | \n | ']
                    ,
                    'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],
                    'text-size': 14,
                    'text-offset': [0, -4],
                },
                "paint": {
                    "text-color": inner_text,
                    "text-halo-color": outer_text,
                    "text-halo-width": 0.8,
                    "text-opacity": ['interpolate', ['exponential', 2], ['zoom'], 8, 0, 10, 1]
                }
            });

        });

        // ===== LAYERS =====

        // ===== MOUSE EVENTS =====
        // Triggers when an individual area is clicked on.

        map.on('click', 'Model_EBus_GPSLocation', function (e) {
            console.log("The click event is triggered")
            var Bus_num = e.features[0].properties.Bus_num;
            var Bus_type = e.features[0].properties.Bus_type;
            var para_Gs = e.features[0].properties.para_Gs;
            var para_Bs = e.features[0].properties.DomesticConsumption;
            var para_area = e.features[0].properties.para_area;
            var para_basekV = e.features[0].properties.para_basekV;
            var para_zone = e.features[0].properties.para_zone;
            var para_Vmax = e.features[0].properties.para_Vmax;
            var para_Vmin = e.features[0].properties.para_Vmin;
          
            selectBus(Bus_num, Bus_type, para_Gs, para_Bs, para_area, para_basekV, para_zone, para_Vmax, para_Vmin);
        });

        map.on('mousemove', 'Model_EBus_GPSLocation', function (e) {

            // Get the human readable name of the crop
            var coordinates = e.lngLat;
            var Bus_num = e.features[0].properties["Bus_num"];

            // Make the text look a little nicer
            var html = `
                    <b> Bus ` + Bus_num + `</b><br>
                    <span style="font-size: 85%;">Click for more details.</span>
                `;

            // Populate the popup and set its coordinates based on the feature found.
            popup.setLngLat(coordinates).setHTML(html).addTo(map);

        });

        // Triggers when the mouse enters the entire layer
        map.on('mouseenter', 'Model_EBus_GPSLocation', function (e) {
            map.getCanvas().style.cursor = 'pointer';
        });

        // Triggers when the mouse leaves the entire layer
        map.on('mouseleave', 'Model_EBus_GPSLocation', function (e) {
            map.getCanvas().style.cursor = '';
            popup.remove();
        });

        map.on('click', 'Electricity_Consumption_area_fill', function (e) {
            var Location = e.features[0].properties.Location;
            var Area_LACode = e.features[0].properties.Area_LACode;
            var TotalELecConsumption = e.features[0].properties.TotalELecConsumption;
            var DomesticConsumption = e.features[0].properties.DomesticConsumption;
            var Industrial_and_Commercial = e.features[0].properties.Industrial_and_Commercial;
            Location = Location.replaceAll("_", " ");

            selectArea(Location, Area_LACode, TotalELecConsumption, DomesticConsumption, Industrial_and_Commercial);
        });

        // Triggers whenever the mouse is moved within the selected layer
        map.on('mousemove', 'Electricity_Consumption_area_fill', function (e) {

            // Get the human readable name of the crop
            var coordinates = e.lngLat;
            var location = e.features[0].properties["Location"];
            var total = e.features[0].properties["TotalELecConsumption"];
            location = location.replaceAll("_", " ");

            // Make the text look a little nicer
            var html = `
                    <b>` + location + `</b><br>
                    Total Consumption [GWh]: ` + total + `<br><br>
                    <span style="font-size: 85%;">Click for more details.</span>
                `;

            // Populate the popup and set its coordinates based on the feature found.
            popup.setLngLat(coordinates).setHTML(html).addTo(map);

            // TODO: Enable this when the geojson has a unique, numeric
            //          "id" property for each feature.

            // if (e.features.length > 0) {
            // if (hoveredStateId !== null) {
            //     map.setFeatureState(
            //         { source: 'Electricity_Consumption_area', Location: hoveredStateId },
            //         { hover: false }
            //     );
            // }

            // hoveredStateId = e.features[0].Location;
            // map.setFeatureState(
            //     { source: 'Electricity_Consumption_area', Location: hoveredStateId },
            //     { hover: true }
            // );
            // }
        });

        // Triggers when the mouse enters the entire layer
        map.on('mouseenter', 'Electricity_Consumption_area_fill', function (e) {
            map.getCanvas().style.cursor = 'pointer';
        });

        // Triggers when the mouse leaves the entire layer
        map.on('mouseleave', 'Electricity_Consumption_area_fill', function (e) {
            map.getCanvas().style.cursor = '';
            popup.remove();

            // TODO: Enable this when the geojson has a unique, numeric
            //          "id" property for each feature.
            // if (hoveredStateId !== null) {
            //     map.setFeatureState(
            //         { source: 'Electricity_Consumption_area', Location: hoveredStateId },
            //         { hover: false }
            //     );
            // }
            // hoveredStateId = null;
        });

        // On mouse enter
        map.on('mouseenter', 'power_locations', function (e) {
            map.getCanvas().style.cursor = 'pointer';

            if (map.getZoom() < 7.5) {
                var coordinates = e.features[0].geometry.coordinates.slice();
                var name = e.features[0].properties["name"];
                name = name.replaceAll("_", " ");

                var fuel = e.features[0].properties["fuel"];

                var html = `
                        <b> ` + name + `</b><br>
                        Fuel: ` + fuel + `
                        <br><p>Click for more details.</p>
                    `;
                popup.setLngLat(coordinates).setHTML(html).addTo(map);
            }
        });

        // On mouse exit
        map.on('mouseleave', 'power_locations', function (e) {
            map.getCanvas().style.cursor = '';
            popup.remove();
        });

        // On selection
        map.on('click', 'power_locations', function (e) {
            var coordinates = e.features[0].geometry.coordinates.slice();
            var name = e.features[0].properties["name"];
            name = name.replaceAll("_", " ");

            var fuel = e.features[0].properties["fuel"];
            var capacity = e.features[0].properties["capacity"];
            var indicator = e.features[0].properties["sdg941"];

            selectPlant(name, fuel, capacity, indicator, coordinates);

            map.flyTo({
                center: coordinates,
                curve: 1.9,
                speed: 1.6,
                pitch: 75,
                zoom: 14,
                bearing: Math.random() * 90
            });
        });

        // On mouse enter
        map.on('mouseenter', 'sdg_locations', function (e) {
            map.getCanvas().style.cursor = 'pointer';

            if (map.getZoom() < 7.5) {
                var coordinates = e.features[0].geometry.coordinates.slice();
                var name = e.features[0].properties["name"];
                name = name.replaceAll("_", " ");

                var fuel = e.features[0].properties["fuel"];

                var html = `
                        <b> ` + name + `</b><br>
                        Fuel: ` + fuel + `
                        <br><p>Click for more details.</p>
                    `;
                popup.setLngLat(coordinates).setHTML(html).addTo(map);
            }
        });

        // On mouse exit
        map.on('mouseleave', 'sdg_locations', function (e) {
            map.getCanvas().style.cursor = '';
            popup.remove();
        });

        // On selection
        map.on('click', 'sdg_locations', function (e) {
            var coordinates = e.features[0].geometry.coordinates.slice();
            var name = e.features[0].properties["name"];
            name = name.replaceAll("_", " ");

            var fuel = e.features[0].properties["fuel"];
            var capacity = e.features[0].properties["capacity"];
            var indicator = e.features[0].properties["sdg941"];

            selectPlant(name, fuel, capacity, indicator, coordinates);

            map.flyTo({
                center: coordinates,
                curve: 1.9,
                speed: 1.6,
                pitch: 75,
                zoom: 14,
                bearing: Math.random() * 90
            });
        });
        // ===== MOUSE EVENTS =====
        // Register the layers with the central controls
        registerLayer("Power Generation", ["power_locations", "power_labels"], null, true);
        registerLayer("SDG Indicator", ["sdg_locations", "sdg_labels"], null, false);
        registerLayer("Electricity Consumption", [
            "Electricity_Consumption_area_fill",
            "Electricity_Consumption_area_borders",
            "Electricity_Consumption_region_borders"
        ],
            null, false);
        registerLayer("10-Bus Grid Model", ["Model_EBus_GPSLocation", "Model_Animated_Branch_Arrow", "Model_Branch_GPS_Points"], null, false);

        // Build the layer selection tree
        buildLayerTree("radio");
    </script>

</body>

</html>
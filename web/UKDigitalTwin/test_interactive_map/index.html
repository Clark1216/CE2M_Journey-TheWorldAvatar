<!DOCTYPE html>
<html>

<head>
    <title>Power System Visualisation</title>
    <meta charset="utf-8">

    <!-- Javascript -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.3.0/mapbox-gl.js'></script>
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js'></script>
    <script src='http://kg.cmclinnovations.com:81/user/themes/quark/js/checktree.js'></script>
    <script src='http://kg.cmclinnovations.com:81/user/themes/quark/js/mapbox-controls.js'></script>
    <script src='http://kg.cmclinnovations.com:81/user/themes/quark/js/side-panel.js'></script>
    <script src='power-system.js'></script>
    <script src='us-states.js'></script>
    <script src='England_Region_(December_2015)_Boundaries.js'></script>
    <script src='Walse_Boundaries.js'></script>
    <script src='Northern_Ireland_Boundery.js'></script>
    <script src='Scotland_Boundaries.js'></script>
    <script src='GB_City_Boundaries.js'></script>
    <script src='Northern_Ireland_City_Boundaries.js'></script>


    <!-- Stylesheets -->
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v2.3.0/mapbox-gl.css' rel='stylesheet' />
    <link href='http://kg.cmclinnovations.com:81/user/themes/quark/css/mapbox-controls.css' rel='stylesheet' />
    <link href='http://kg.cmclinnovations.com:81/user/themes/quark/css/side-panel.css' rel='stylesheet' />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
          integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
          crossorigin="" />
    <link href='style.css' rel='stylesheet' />


    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
            integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
            crossorigin=""></script>

    <style>
        #UKInteractiveMap {
            height: 1800px;
        }
    </style>
</head>

<body>
    <!-- div is a DOM element -->
    <div id='map'></div>
    <div id="tiltShift"></div>
    <div id="controlsParent"></div>
    <!--<div id="UKInteractiveMap"></div>-->

    <script>

        // ###############################################################################################################################################################
        var currentLayer = "power";

        // Add map controls
        document.getElementById("controlsParent").innerHTML = getControls();
        // The getControls() is invoked from the mapbox-controls.js for returning a controlHTML containing camera, terrain, and layer panels

        // Initial state of side-panel (from side-panel.js)
        initialiseSidePanel(document.getElementById("map"));
        // Reset side panel (from power-system.js)
        resetSidePanel();

        // Show loading icon whilst stuff spins up
        var loadingHTML = `
				<br><br><br><br><br>
				<img width='150' src='loading.gif'></img>
				<br>
				<span style='color: grey; font-style: italic;'>Loading data, please wait...</span>
			`;
        appendSidePanelText(loadingHTML);

        // Initialise the MapBox map
        mapboxgl.accessToken = 'pk.eyJ1Ijoiam1hcnNkZW4iLCJhIjoiY2ttZzNqM3IxM2JyYzJ2bndzZnIxeG1lciJ9.uwb9ZnBO3vWssvcBsXcFeA';
        var map = new mapboxgl.Map(getDefaultMapOptions());

        // Initialise MapBox popup for mouse-overs
        var popup = popup = new mapboxgl.Popup({
            closeButton: false,
            closeOnClick: false
        });

        // Change some layer colors depending on selected style
        var inner_text = '#3E3E3E';
        var outer_text = '#FFFFFF';

        function terrainCallback(terrainType) {
            if (terrainType === "light") {
                inner_text = '#3E3E3E';
                outer_text = '#FFFFFF';
            } else {
                inner_text = '#FFFFFF';
                outer_text = '#000000';
            }
            console.log("INFO: Updated label colors.");
        }

        function cameraCallback() {
            popup.remove();
            resetSidePanel();
            updateLegend(currentLayer);
        }

        function layerCallback(layerID, enabled) {
            if (layerID == "power" && enabled) {
                map.setPaintProperty(
                    "plant_locations",
                    "circle-color",
                    ["get", "marker-color"]
                );

                currentLayer = "power";
                updateLegend("power");

            } else if (layerID == "indicator" && enabled) {
                map.setPaintProperty(
                    "plant_locations",
                    "circle-color",
                    ["get", "sdgcolor"]
                );

                currentLayer = "indicator";
                updateLegend("indicator");
            }
        }

        // Setup map with mapbox-controls.js
        setup(map, cameraCallback, terrainCallback, layerCallback); // ************the layerCallback needs to be passed two arguments?????


        // Add tilt shift effect
        // Note: I've disabled this for now as the map is becoming unresponsive.
        // Once we've had time for some optimisation, we can enable it.
        //addTiltShiftSupport();

        // On initial load...
        map.on("load", function () { 
            resetSidePanel();
            updateLegend(currentLayer);

            map.addSource('Electricity_Consumption', {
                type: 'geojson',
                data: 'UK_Electricity_Consumption.geojson'
            });


            map.addLayer({
                'id': 'Electricity_Consumption_fill',
                'type': 'fill',
                'source': 'Electricity_Consumption', // reference the data source
                'layout': {},
                'paint': {
                    // 'fill-color': 'rgba(200, 100, 240, 0.4)',
                    // 'fill-outline-color': 'rgba(200, 100, 240, 1)',
                    // 'fill-antialias': false
                    'fill-color': '#0080ff', // blue color fill
                    'fill-opacity': 0.5
                }
            });

            map.addLayer({
                'id': 'Electricity_Consumption_line',
                'type': 'line',
                'source': 'Electricity_Consumption', // reference the data source
                'layout': {},
                'paint': {
                    // 'fill-color': 'rgba(200, 100, 240, 0.4)',
                    // 'fill-outline-color': 'rgba(200, 100, 240, 1)',
                    // 'fill-antialias': false
                    'line-color': '#9ecae1',
                    'line-width': 2
                }
            });

            map.on('click', 'Electricity_Consumption_fill', function (e) {
                new mapboxgl.Popup()
                    .setLngLat(e.lngLat)
                    .setHTML(e.features[0].properties.TotalELecConsumption)
                    .addTo(map);
            });

            // Change the cursor to a pointer when the mouse is over the states layer.
            map.on('mouseenter', 'Electricity_Consumption_fill', function () {
                map.getCanvas().style.cursor = 'pointer';
            });

            // Change it back to a pointer when it leaves.
            map.on('mouseleave', 'Electricity_Consumption_fill', function () {
                map.getCanvas().style.cursor = '';
            });


        });

       map.on('style.load', function () {
            console.log("INFO: New style has been loaded.");
            refresh();

            // ============ PLANTS ===========
            // Add the powerplant data
            map.addSource('powerplants', {
                type: 'geojson',
                data: 'UK_PowerPlants.geojson'
            });

            // Powerplant icons
            map.addLayer({
                'id': 'plant_locations',
                'type': 'circle',
                'source': 'powerplants',
                'layout': {
                    'visibility': 'visible'
                },
                'paint': {
                    'circle-radius': ["+", 3, ["*", 0.9, ["ln", ["to-number", ["get", "capacity"]]]]],
                    'circle-color': (currentLayer == "power") ? ["get", "marker-color"] : ["get", "sdgcolor"],
                    'circle-stroke-width': 1,
                    'circle-stroke-color': inner_text,
                }
            });

            // Powerplant labels
            map.addLayer({
                id: 'plant_labels',
                type: 'symbol',
                source: 'powerplants',
                layout: {
                    'visibility': 'visible',
                    'text-field': ['concat',
                        ['get', 'name'],
                        '\n Capacity: ',
                        ['get', 'capacity'],
                        ' MW \n Fuel: ',
                        ['get', 'fuel'],
                        ' \n | \n | \n | \n | ']
                    ,
                    'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],
                    'text-size': 14,
                    'text-offset': [0, -4],
                },
                "paint": {
                    "text-color": inner_text,
                    "text-halo-color": outer_text,
                    "text-halo-width": 0.8,
                    "text-opacity": ['interpolate', ['exponential', 2], ['zoom'], 8, 0, 10, 1]
                }
            });

            // On mouse enter
            map.on('mouseenter', 'plant_locations', function (e) { //*************what is "e"?
                map.getCanvas().style.cursor = 'pointer';

                if (map.getZoom() < 7.5) {
                    var coordinates = e.features[0].geometry.coordinates.slice();
                    var name = e.features[0].properties["name"];
                    name = name.replaceAll("_", " ");

                    var fuel = e.features[0].properties["fuel"];

                    var html = `
							<b> ` + name + `</b><br>
							Fuel: ` + fuel + `
							<br><p>Click for more details.</p>
						`;
                    popup.setLngLat(coordinates).setHTML(html).addTo(map);
                }
            });

            // On mouse exit
            map.on('mouseleave', 'plant_locations', function (e) {
                map.getCanvas().style.cursor = '';
                popup.remove();
            });

            // On selection
            map.on('click', 'plant_locations', function (e) {
                var coordinates = e.features[0].geometry.coordinates.slice();
                var name = e.features[0].properties["name"];
                name = name.replaceAll("_", " ");

                var fuel = e.features[0].properties["fuel"];
                var capacity = e.features[0].properties["capacity"];
                var indicator = e.features[0].properties["sdg941"];

                selectPlant(name, fuel, capacity, indicator, coordinates);
                //updateLegend(currentLayer);

                map.flyTo({
                    center: coordinates,
                    curve: 1.9,
                    speed: 1.6,
                    pitch: 75,
                    zoom: 14,
                    bearing: Math.random() * 90
                });
            });
        });

        // Register the power layer
        registerLayer("Power Generation", ["power"], null, (currentLayer == "power"));
        registerLayer("SDG Indicator", ["indicator"], null, (currentLayer == "indicator"));
        registerLayer("UK Electricity Consumption Data", ["eleCon"], null, (currentLayer == "eleCon"));

        // ============ PLANTS ===========

        // Build the layer selection tree
        buildLayerTree("radio");
    </script>

</body>

</html>
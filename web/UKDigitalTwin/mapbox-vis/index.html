<!DOCTYPE html>
<html>

<head>
	<title>Power System Visualisation</title>
	<meta charset="utf-8">
	
	<!-- Javascript -->
	<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v2.3.0/mapbox-gl.js'></script>
	<script src='http://kg.cmclinnovations.com:81/user/themes/quark/js/mapbox-controls.js'></script>

	<!-- Stylesheets -->
	<link href='https://api.tiles.mapbox.com/mapbox-gl-js/v2.3.0/mapbox-gl.css' rel='stylesheet' />
	<link href='http://kg.cmclinnovations.com:81/user/themes/quark/css/mapbox-controls.css' rel='stylesheet' />
	<link href='style.css' rel='stylesheet' />
</head>

<body>
	<div id='map'></div>
	<div id="tiltShift"></div>
	<div id="controlsParent"></div>

	<script>
		// Add map controls
		window.addEventListener("load", function(){
			document.getElementById("controlsParent").innerHTML = getControls();
		});

		// Access token
		mapboxgl.accessToken = 'pk.eyJ1Ijoiam1hcnNkZW4iLCJhIjoiY2ttZzNqM3IxM2JyYzJ2bndzZnIxeG1lciJ9.uwb9ZnBO3vWssvcBsXcFeA';
	
		// Create map (options may be override later)
		var map = new mapboxgl.Map(getDefaultMapOptions());

		// Change text color depending on selected style
		var inner_text = '#FFFFFF';
		var outer_text = '#000000';

		function terrainCallback(terrainType) {
			if(terrainType === "light") {
				outer_text = '#FFFFFF';
				inner_text = '#3E3E3E';
			} else {
				inner_text = '#FFFFFF';
				outer_text = '#000000';
			}
			console.log("INFO: Updated label colors.");
		}		

		// Setup map with mapbox-controls.js
		setup(map, null, terrainCallback);
		addTiltShiftSupport();

		map.on('style.load', function() {
			console.log("INFO: New style has been loaded.");

			// Initialise the map options 
			refresh();
			
			// Add the powerplant data
			map.addSource('powerplants', {
				type: 'geojson',
				data: 'UK_PowerPlants.geojson'
			});

			// Powerplant icons
			map.addLayer({
				'id': 'plant_locations',
				'type': 'circle',
				'source': 'powerplants',
				'layout': {},
				'paint': {
					'circle-radius': ["+", 3, ["*", 0.9, ["ln", ["to-number", ["get", "capacity"]]]]],
					'circle-color': ["get", "marker-color"],
					'circle-stroke-width': 1,
					'circle-stroke-color': inner_text,
				}
			});

			// Powerplant labels
			map.addLayer({
				id: 'capac_label',
				type: 'symbol',
				source: 'powerplants',
				layout: {
					'text-field': ['concat',
						['get', 'name'],
						'\n Capacity: ',
						['get', 'capacity'],
						' MW \n Fuel: ',
						['get', 'fuel'],
						' \n | \n | \n | \n | ']
					,
					'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],
					'text-size': 14,
					'text-offset': [0, -4],
				},
				"paint": {
					"text-color": inner_text,
					"text-halo-color": outer_text,
					"text-halo-width": 0.8,
					"text-opacity": ['interpolate', ['exponential', 2], ['zoom'], 8, 0, 10, 1]
				}
			});

			// On mouse enter
			map.on('mouseenter', 'plant_locations', function () {
				map.getCanvas().style.cursor = 'pointer';
			});

			// On mouse exit
			map.on('mouseleave', 'plant_locations', function () {
				map.getCanvas().style.cursor = '';
			});

			// On selection
			map.on('click', 'plant_locations', function (e) {
				var coordinates = e.features[0].geometry.coordinates;
				map.flyTo({
					center: coordinates,
					curve: 1.9,
					speed: 1.6,
					pitch: 75,
					zoom: 14,
					bearing: Math.random() * 90
				});
			});
		});
	</script>

</body>

</html>
<html>
    <head>
        <!-- ===== CUSTOMISABLE ===== -->
        <title>DTVF v2.0.0</title>
        <!-- ===== CUSTOMISABLE ===== -->

        <!-- JS -->
        <script src='https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js'></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
        <script src='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js'></script>
        <script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>
        <script src="https://cdn.jsdelivr.net/gh/hummingbird-dev/hummingbird-treeview@v3.0.4/hummingbird-treeview.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.5.1/chart.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-adapter-moment/1.0.0/chartjs-adapter-moment.js"></script>
        <script src="https://kg.cmclinnovations.com/cdn/dtvf/2.0.2/dtvf.min.js"></script>

        <!-- ===== CUSTOMISABLE ===== -->
        <!-- JavaScript files to provide functionality specifically for this visualisation instance can go here. -->
        <script src="./local.js"></script>
        <!-- ===== CUSTOMISABLE ===== -->

        <!-- CSS -->
        <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css" rel="stylesheet" />
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/gh/hummingbird-dev/hummingbird-treeview@v3.0.4/hummingbird-treeview.min.css" rel="stylesheet">
        <link href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css" rel="stylesheet">
        <link href="https://kg.cmclinnovations.com/cdn/dtvf/2.0.2/dtvf.min.css" rel="stylesheet" />

        <!-- ===== CUSTOMISABLE ===== -->
        <!-- CSS files to provide styling specifically for this visualisation instance can go here. -->
        <link href="./local.css" rel="stylesheet" />
        <!-- ===== CUSTOMISABLE ===== -->

    </head>
    <body>
        <!-- Container the map will be added to -->
        <div id="map"></div>

        <!-- Element for depth of field overlay -->
        <div id="tiltShift"></div>

        <!-- Element the map controls will be added to (normally on the left) -->
        <div id="controlsContainer">
            <div id="controlContainer">

                <!-- Camera controls -->
                <div id="cameraContainer" class="controlBlock">
                    <div id="controlTitle" class="controlTitle">
                        <p>Camera</p>
                        <div class="tooltip">
                            <label class="switch"><input type="checkbox" onclick="MapBoxUtils.setTiltshift(this.checked)"><span class="slider round"><p>DoF</p></label>
                            <span class="tooltiptext">Toggle depth of field effect</span>
                        </div>
                    </div>
                    <div class="controlContents">
                        <a href="#" onclick="MapBoxUtils.changeCamera('bird')">Bird's Eye</a><br/>
                        <a href="#" onclick="MapBoxUtils.changeCamera('pitch')">Pitched</a>
                    </div>
                </div>

                <!-- Terrain controls -->
                <div id="terrainContainer" class="controlBlock">
                    <div id="controlTitle" class="controlTitle">
                        <p>Terrain</p>
                        <div class="tooltip">
                            <label class="switch"><input type="checkbox" onclick="MapBoxUtils.set3DTerrain(this.checked)"><span class="slider round"><p>3D</p></label>
                            <span class="tooltiptext">Toggle 3D terrain</span>
                        </div>
                    </div>
                    <div class="controlContents">
                        <input type="radio" name="terrain" id="light" onclick="MapBoxUtils.changeTerrain('light')" checked>
                        <label for="light">Light</label><br/>
                        <input type="radio" name="terrain" id="dark" onclick="MapBoxUtils.changeTerrain('dark')">
                        <label for="dark">Dark</label><br/>
                        <input type="radio" name="terrain" id="outdoors" onclick="MapBoxUtils.changeTerrain('outdoors')">
                        <label for="outdoors">Outdoors</label><br/>
                        <input type="radio" name="terrain" id="satellite" onclick="MapBoxUtils.changeTerrain('satellite')">
                        <label for="satellite">Satellite</label><br/>
                    </div>
                </div>

                <!-- Layer controls -->
                <div id="layerContainer" class="controlBlock">
                    <div id="controlTitle"  class="controlTitle">
                        <p>Layers</p>
                        <div class="tooltip" id="placenameContainer">
                            <label class="switch"><input type="checkbox" onclick="MapBoxUtils.setPlacenames(this.checked)" checked><span class="slider round"><p>PNs</p></label>
                            <span class="tooltiptext">Toggle place names, labels, and roads </span>
                        </div>
                    </div>
                    <div class="controlContents">
                        <div id="layerTreeContainer">
                            <div class="hummingbird-treeview-converter"></div>
                        </div>
                    </div>
                </div>

                <!-- Container for developer info -->
                <div id="developerContainer" class="controlBlock" style="display: none;">
                    <div class="tooltip" id="coordEditor" style="float: right;">
                        <i class="fas fa-pencil-alt" onclick="event.stopPropagation(); manager.getControlHandler().editInfoPanel()"></i>
                        <span class="tooltiptext">Change map position</span>
                    </div>
                    <div id="coordsContainer" style="width: 100%; height: 100%;"></div>
                </div>
            </div>

            <!-- BETA FEATURE -->
            <div id="finderContainer" class="controlBlock expanded" style="display:none;">
                <label style="width:110px; height:100%; display:inline-block; color:white; line-height:40px;">Search Term:</label>
                <input type="text" id="findInput" name="findInput" placeholder="Enter feature name..." style="height:100%; width:calc(100% - 200px); padding-left:10px;" oninput="manager.updateSearch(this)"></input>

                <div class="tooltip" style="float:right; width:40px; height:100%; text-align:center; display:table; cursor:pointer;" onclick="manager.hideSearch()">
                    <i class="fas fa-chevron-down" style="width:100%; height:100%; font-size:18pt! important; color:white; display:table-cell; vertical-align:middle;"></i>
                    <span class="tooltiptext">Hide control</span>
                </div>
                <div class="tooltip" style="float:right; width:40px; height:100%; text-align:center; display:table; cursor:pointer;" onclick="manager.cancelSearch()">
                    <i class="fas fa-times" style="width:100%; height:100%; font-size:18pt! important; color:white; display:table-cell; vertical-align:middle;"></i>
                    <span class="tooltiptext">Cancel search</span>
                </div>
            </div>
        </div>

        <!-- Side panel for content and metdata -->
        <div id="sidePanel" class="large expanded">
            <div class="tooltip" id="slideButtonContainer">
                <i class="fas fa-chevron-right" id="slideButton" width="16px" class="leftButton" height="16px" onclick="manager.getPanelHandler().toggleExpansion()"></i>
                <span class="tooltiptext">Expand/Collapse</span>
            </div>
            <div class="tooltip" id="expandButtonContainer">
                <i class="fas fa-expand" id="expandButton" width="16px" class="rightButton" height="16px" onclick="manager.getPanelHandler().toggleMode()"></i>
                <span class="tooltiptext">Maximise/Minimise</span>
            </div>
            <div id="sidePanelInner">
                <ul>
                    <li><a href="#sidePanelGeneral">General</a></li>
                    <li><a href="#sidePanelLegend">Legend</a></li>
                    <li><a href="#sidePanelLinks">Links</a></li>
                </ul>
                <div id="sidePanelGeneral">
                    <div id="titleContainer" onclick="manager.moveMapToFeature()"></div>
                    <div id="contentContainer"></div>
                    <div id="legendContainer"></div>
                    <div id="footerContainer">
                        <div id="footerContent"></div>
                    </div>
                </div>
                <div id="sidePanelLegend"></div>
                <div id="sidePanelLinks"></div>
            </div>
            <div id="returnContainer" style="display: none;">
                <div id="innerReturnContainer">
                    <a href="#" onclick="manager.getPanelHandler().returnToDefault()"><i class="fas fa-arrow-left" width="16px" height="16px"></i> Return</a>
                </div>
            </div>
        </div>

        <!-- Code entry point -->
        <script>
            $("#sidePanelInner").tabs();

            // ===== CUSTOMISABLE =====
            // Enter MapBox API key here!
            MapHandler.MAP_API = "pk.eyJ1IjoibWhpbGxtYW4iLCJhIjoiY2t1NW5wMDF3MnBzaDJ2cWhyZ2MxbHh4diJ9.TPv5CXdhGvFPkL28tTeXTA";
            // ===== CUSTOMISABLE =====

            // Create a new manager instance
            var manager = new Manager(MapProvider.MAPBOX);
            window.manager = manager;

            // ===== CUSTOMISABLE =====
            // Add base URLs of stacks here
            var dataPromise = manager.loadDefinitions();
            // ===== CUSTOMISABLE =====
            
             // Only start the map after data definitions have been read.
            dataPromise.then(() => start());

            /**
             * Starts the visualisation setup process.
             */
            function start() {
                // ===== CUSTOMISABLE =====
                // Optionally provide default map settings.
                // If no options are provided here , any included in the root group of the first stack that responds and loads
                // will be used (this is unreliable, so if visualising multiple stacks, I  recommend using this override). - Michael
                let optionsOverride = {
                    "center": [-1.12187957763671875, 52.2040299172616],
                    "zoom": 5,
                    "bearing": 0,
                    "pitch": 45,
                    "style": "mapbox://styles/mapbox/outdoors-v10?optimize=true"
                };
                // ===== CUSTOMISABLE =====

                // Initialise the map object
                manager.initialiseMap(optionsOverride);
                
               
                // ===== CUSTOMISABLE =====
                // Set the default content in the "General" tab of the side panel
                manager.getPanelHandler().setTitle("<h1>Power Line Visualisation</h1>");
                manager.getPanelHandler().setContent(`
                    <p>This is a simple visualisation of the power lines and pylons used by the National Grid and UK Power Networks.</p>
                `);
                
                // Use the local.js file to build the legend
                buildLegend();

                manager.getPanelHandler().setFooter("The World Avatar, " + new Date().getFullYear());
                // ===== CUSTOMISABLE =====

                // Save general tab state as default
                manager.getPanelHandler().storeDefault();

                // Once the underlying style has loaded...
                MapHandler.MAP.on("style.load", function() {

                    // Load registered images and linked files
                    manager.loadImagesAndLinks().then(() => {

                        // TODO: This SHOULD only kick in after all images have bee loaded and added to the map,
                        // but I cannot get the nest Promises to wait for each other properly. As it doesn't
                        // seem to be causing any issues, I'm leaving it as is for the time being. - Michael

                        // Plot the default visible data
                        manager.plotData();
                    });
                });
            }
          
        </script>
    </body>
</html>
#
# Compose file for the DTVF.
#
version: "3.8"

# All Services
services:

  # Empty DTVF visualisation image for deployment. Builds a base image that, when combined
  # with a volume of files, can be used as a visualisation. It is not intended that this
  # config is used to run the dtvf-base-image.
  visualise:
    image: ghcr.io/cambridge-cares/dtvf-base-image:${TAG}
    container_name: "empty-dtvf-container"
    restart: "no"
    build:
      context: "../"
      dockerfile: "./docker/Dockerfile"
      labels:
        authors: "support@cmcl.io"
        description: "Empty visualisation image, ready to house web files."
    ports:
      - "80:80" 

  # Compilation container.
  # This container will compile the source code, package it for deployment, write it to the ./output folder, then shutdown.
  compile:
    build:
      context: ./
      dockerfile: ./build.Dockerfile
    image: ghcr.io/cambridge-cares/dtvf-build-environment:latest
    container_name: "dtvf-build-compile"
    restart: "no"
    working_dir: "/app"
    entrypoint: "/bin/bash -c 'npm install && tsc && grunt package'"
    volumes:
      - type: bind
        source: ../
        target: /app
<!DOCTYPE html>
<html lan="eng">

<head>
    <title>Gas Grid Visualisation</title>

    <!-- JS libraries -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.3.0/mapbox-gl.js'></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src='live-chart.js'></script>

    <!-- Stylesheets -->
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.3.0/mapbox-gl.css' rel='stylesheet' />
    <link href='style.css' rel='stylesheet' />
</head>

<body>
    <div id="map"></div>
    <div id="tiltShift"></div>

    <div id="resetContainer">
        <a href="javascript:void(0)" onclick="resetCamera()">Birds Eye View</a>
    </div>

    <div id="pitchedContainer">
        <a href="javascript:void(0)" onclick="pitchedCamera()">Pitched View</a>
    </div>



    <div id="side-panel" style="height:100%; width:400px; float:right;">
        <div id="titleContainer">
            <h2>UK Gas Grid</h2>
        </div>
        <div id="metadataContainer"></div>
        <div id="textContainer"></div>
        <div id="chartContainer"></div>
        <div id="tableContainer"></div>
        <div id="dateContainer"></div>
    </div>

    <div id="menu">
        <input id="satellite-v9" type="radio" name="rtoggle" value="satellite" checked="checked">
        <label for="satellite-v9">Satellite</label>
        <input id="light-v10" type="radio" name="rtoggle" value="light">
        <label for="light-v10">Light</label>
        <input id="satellite-streets-v11" type="radio" name="rtoggle" value="streets">
        <label for="satellite-streets-v11">Satellite with streets</label>
    </div>


    <script>
        // Initial state of UI elements
        resetSidePanel();

        // Loading icon
        document.getElementById("textContainer").innerHTML += `
            <br><br><br><br><br>
            <img width='150' src='loading.gif'></img>
            <br>
            <span style='color: grey; font-style: italic;'>Loading data, please wait...</span>
        `;


        // Resets the camera
        function resetCamera() {
            if (typeof map !== 'undefined') {

                map.flyTo({
                    curve: 1.9,
                    speed: 1.6,
                    zoom: 5,
                    pitch: 0.0,
                    bearing: 0.0,
                    center: [-2, 54.5]
                });
                resetSidePanel();
            }
        }

        function pitchedCamera() {
            if (typeof map !== 'undefined') {

                map.flyTo({
                    curve: 1.9,
                    speed: 1.6,
                    zoom: 7,
                    pitch: 65,
                    bearing: -30,
                    center: [-1.5, 52.5]
                });
                resetSidePanel();
            }
        }





        var tiltShiftMaxBlur = 3; // The maximum blur, in pixels, when the tilt-shift effect is fully on. 3 pixels is subtle and nice
        var tiltShiftBlur = document.getElementById("tiltShift");
        var mapDiv = document.getElementById("map");
        var bodyTag = document.getElementById("bodyTag");


        // These easing functions are useful to ensure the amount of blur is 
        // not applied in a linear fashion when zooming in and out. 
        function easeInCubic(x) {
            return x * x * x;
        }

        function easeOutCubic(x) {
            return 1 - Math.pow(1 - x, 3);
        }
        function easeInExpo(x) {
            return x === 0 ? 0 : Math.pow(2, 10 * x - 10);
        }
        function easeOutExpo(x) {
            return x === 1 ? 1 : 1 - Math.pow(2, -10 * x);
        }

        function degreesToRadians(degrees) {
            var pi = Math.PI;
            return degrees * (pi / 180);
        }
        function addPhotoEffects() {
            // Get the map state and preapare some useful normalized values of zoom and pitch
            // ==============================================================================
            var pitch = map.getPitch();
            var pitchNormalized = pitch / 85;

            var bearing = map.getBearing() + 180;
            var zoom = map.getZoom() - 4;
            var fractionZoomedOut = 1 - (zoom / 18);
            var fractionPitched = (pitch / 80);
            var fractionPitchedBackwards = Math.max(1 - (pitch / 80), 0);

            var tiltShiftBackdropFilter = 'blur(' + ((tiltShiftMaxBlur * easeInCubic(fractionPitched)) * fractionZoomedOut) + 'px)';
            var tiltShiftGradientBlackPoint = (75 + (25 * easeOutCubic(fractionPitchedBackwards)));

            tiltShiftBlur.style.backdropFilter = tiltShiftBackdropFilter;
            tiltShiftBlur.style.webkitBackdropFilter = tiltShiftBackdropFilter;

            // this needs to be styled in two different ways to support the most browsers
            tiltShiftBlur.style.webkitMaskImage = '-webkit-gradient(linear, left bottom, left top, from(black), color-stop(5%, black), color-stop(45%, rgba(0, 0, 0, 0)), color-stop(55%, rgba(0, 0, 0, 0)), color-stop(' + tiltShiftGradientBlackPoint + '%, black), to(black))';
            tiltShiftBlur.style.maskImage = 'linear-gradient(0deg, black 0%, black 5%, rgba(0, 0, 0, 0) 45%, rgba(0, 0, 0, 0) 55%, black ' + tiltShiftGradientBlackPoint + '%)';
        }


        // MapBox API Token
        mapboxgl.accessToken = 'pk.eyJ1IjoiY21jbGlubm92YXRpb25zIiwiYSI6ImNrbGdqa3RoNDFnanIyem1nZXR3YzVhcmwifQ.hVk983r6YYlmFE8kSMbzhA';

        // Load the map visualisation
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/satellite-v9',
            zoom: 7,
            pitch: 65,
            bearing: -30,
            center: [-1.5, 52.5]
        });
        map.addControl(new mapboxgl.NavigationControl());

        var layerList = document.getElementById('menu');
        var inputs_style = layerList.getElementsByTagName('input');

        var inner_text = '#FFFFFF';
        var outer_text = '#000000';

        function switchLayer(layer) {
            var layerId = layer.target.id;
            map.setStyle('mapbox://styles/mapbox/' + layerId);
            if (layerId == 'satellite-v9' || layerId == 'satellite-streets-v11') {
                inner_text = '#FFFFFF';
                outer_text = '#000000';
            }
            else {
                outer_text = '#FFFFFF';
                inner_text = '#3E3E3E';
            }
        }

        var lastClick = new Date();

        // On load start...
        map.on('style.load', function () {
            for (var i = 0; i < inputs_style.length; i++) {
                inputs_style[i].onclick = switchLayer;
            }

            // Pre-load the flow data
            loadFlowData();

            // Sky layer that will show when the map is highly pitched
            map.addLayer({
                'id': 'sky',
                'type': 'sky',
                'paint': {
                    'sky-type': 'atmosphere'
                }
            });

            // 3D buildings data
            if (!map.getSource('composite')) {
                map.addSource('composite', {
                    type: 'vector',
                    url: 'mapbox://mapbox.mapbox-streets-v7'
                }
                );
            }

            // Layer style for 3D buildings
            map.addLayer({
                'id': '3d-buildings',
                'source': 'composite',
                'source-layer': 'building',
                'filter': ['==', 'extrude', 'true'],
                'type': 'fill-extrusion',
                'minzoom': 15,
                'paint': {
                    'fill-extrusion-color': '#919191',
                    'fill-extrusion-height': [
                        'interpolate',
                        ['linear'],
                        ['zoom'],
                        15,
                        0,
                        15.05,
                        ['get', 'height']
                    ],
                    'fill-extrusion-base': [
                        'interpolate',
                        ['linear'],
                        ['zoom'],
                        15,
                        0,
                        15.05,
                        ['get', 'max_height']
                    ],
                    'fill-extrusion-opacity': 0.75
                }
            },
                labelLayerId
            );

            // ADDING CSS TILT-SHIFT 
            addPhotoEffects();

            tiltShiftBlur.style.display = "block";
            map.on('move', function () {
                addPhotoEffects();

            });

            // map.setFog({
            //     'color': 'white',
            //     'horizon-blend': 0.05
            // });
            // Add terrain 
            map.addSource('mapbox-dem', {
                'type': 'raster-dem',
                'url': 'mapbox://mapbox.mapbox-terrain-dem-v1',
                'tileSize': 512,
                'maxzoom': 14
            });
            map.setTerrain({ 'source': 'mapbox-dem', 'exaggeration': 1.5 });


            // ============ PIPES ===========	
            // Add the geoJSON data for NTS
            map.addSource('National Transmission System', {
                type: 'geojson',
                data: '/geoJSON_assets/pipe_network.geojson'
            });

            // Add layer style for NTS
            map.addLayer({
                'id': 'National Transmission System',
                'type': 'line',
                'source': 'National Transmission System',
                'layout': {
                    'line-join': 'round',
                    'line-cap': 'round'
                },
                'paint': {
                    'line-color': inner_text,
                    'line-width': 4
                }
            });

            // ============ OFFTAKES ===========	
            // Add the geoJSON data for offtakes
            map.addSource('offtakes', {
                type: 'geojson',
                data: '/geoJSON_assets/offtakes.geojson'
            });

            // Add layer style for offtakes
            map.addLayer({
                'id': 'offtakes_loc',
                'type': 'circle',
                'source': 'offtakes',
                'paint': {
                    'circle-radius': 6,
                    'circle-color': '#B42222',
                    'circle-opacity': 0.9,
                    "circle-stroke-width": 1,
                    "circle-stroke-color": '#FFFFFF',
                }
            });

            // On click handler within offtake layer
            map.on('click', 'offtakes_loc', function (e) {
                // Prevent if within a second of last click
                var nowClick = new Date();
                var millis = Math.abs(nowClick.getTime() - lastClick.getTime());

                if (millis < 1000) return;
                lastClick = nowClick;

                var coordinates = e.features[0].geometry.coordinates.slice();
                var name = e.features[0].properties["Offtake Point (License Name)"];
                var type = e.features[0].properties["Type of Offtake"];

                // Fire selection logic
                showOfftake(name, type, coordinates);

                map.flyTo({
                    center: coordinates,
                    curve: 1.9,
                    speed: 1.6,
                    pitch: 75,
                    zoom: 15.5
                });

            });
            // On mouse enter within offtake layer
            map.on('mouseenter', 'offtakes_loc', function (e) {
                map.getCanvas().style.cursor = 'pointer';
            });

            // On mouse leave within offtake layer
            map.on('mouseleave', 'offtakes_loc', function () {
                map.getCanvas().style.cursor = '';
            });

            // ============ TERMINALS ===========	
            // Add the geoJSON data for terminals
            map.addSource('terminals_s', {
                'type': 'geojson',
                'data': '/geoJSON_assets/terminals.geojson'
            });

            // Layer style for terminals
            map.addLayer({
                'id': 'terminals',
                'type': 'circle',
                'source': 'terminals_s',
                'paint': {
                    'circle-radius': 8,
                    'circle-color': '#108dcc',
                    'circle-opacity': 0.9,
                    "circle-stroke-width": 1,
                    "circle-stroke-color": '#FFFFFF',
                }
            });

            // On click handler within offtake layer
            map.on('click', 'terminals', function (e) {
                // Prevent if within a second of last click
                var nowClick = new Date();
                var millis = Math.abs(nowClick.getTime() - lastClick.getTime());

                if (millis < 1000) return;
                lastClick = nowClick;

                var coordinates = e.features[0].geometry.coordinates.slice();
                var name = e.features[0].properties.name;
                var type = "Terminal";
                map.flyTo({
                    center: coordinates,
                    curve: 1.9,
                    speed: 1.6,
                    pitch: 60,
                    zoom: 16
                });
                // Update the side panel
                showTerminal(name, type, coordinates);


            });


            map.addLayer({
                id: 'terminals_name',
                type: 'symbol',
                source: 'terminals_s',
                layout: {
                    'text-field': ['concat', ['get', 'name'], '\n |\n|\n|'],
                    'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],
                    'text-size': 14,
                    'text-offset': [0, -2.5],
                },
                "paint": {
                    "text-color": inner_text,
                    "text-halo-color": outer_text,
                    "text-halo-width": 1,
                    "text-opacity": ['interpolate', ['exponential', 2], ['zoom'], 5, 0, 7, 1]
                }
            });

            map.addLayer({
                id: 'offtakes_name',
                type: 'symbol',
                source: 'offtakes',
                layout: {
                    'text-field': ['concat', ['get', 'Offtake Point (License Name)'], '\n Offtake Type: ', ['get', 'Type of Offtake'], '\n | \n | \n |'],
                    'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],
                    'text-size': 12,
                    'text-offset': [0, -3.5]
                },
                "paint": {
                    "text-color": inner_text,
                    "text-halo-color": outer_text,
                    "text-halo-width": 1,
                    "text-opacity": ['interpolate', ['exponential', 2], ['zoom'], 5, 0, 7, 1]
                }
            });

            // On mouse enter within offtake layer
            map.on('mouseenter', 'terminals', function (e) {
                map.getCanvas().style.cursor = 'pointer';
            });

            // On mouse leave within offtake layer
            map.on('mouseleave', 'terminals', function () {
                map.getCanvas().style.cursor = '';
            });

            var layers = map.getStyle().layers;
            var labelLayerId;
            for (var i = 0; i < layers.length; i++) {
                if (layers[i].type === 'symbol' && layers[i].layout['text-field']) {
                    labelLayerId = layers[i].id;
                    break;
                }
            }

            resetSidePanel();
        });
    </script>
</body>

</html>
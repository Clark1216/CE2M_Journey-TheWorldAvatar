<!DOCTYPE html>
<html lan="eng">

<head>
	<title>Gas Grid Visualisation</title>
	
	<!-- JS libraries -->
	<script src='https://api.mapbox.com/mapbox-gl-js/v2.0.0/mapbox-gl.js'></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script src="https://d3js.org/d3.v6.min.js"></script>
	<script src='live-chart.js'></script>
	
	<!-- Stylesheets -->
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.0.0/mapbox-gl.css' rel='stylesheet' />
	<link href='style.css' rel='stylesheet' />  
</head>

<body>
    <div id="map"></div>
	
	<div id="resetContainer">
        <a href="javascript:void(0)" onclick="resetCamera()">Reset View</a>
	</div>
	
	<div id="side-panel" style="height:100%; width:400px; float:right;">
		<div id="titleContainer">
            <h2>UK Gas Grid</h2>
        </div>
		<div id="metadataContainer"></div>
        <div id="textContainer"></div>
		<div id="chartContainer"></div>
		<div id="tableContainer"></div>
		<div id="dateContainer"></div>
	</div>
	
    <script>	
        // Initial state of UI elements
        resetSidePanel();

		// Resets the camera
		function resetCamera() {
			if(typeof map !== 'undefined') {
			
			    map.flyTo({
                    curve: 1.9,
                    speed: 1.6,
                    zoom: 6.,
					pitch: 0.0,
					bearing: 0.0,
					center: [-2, 53.25]
                });
                resetSidePanel();
			}
		}
								
		// MapBox API Token
		mapboxgl.accessToken = 'pk.eyJ1IjoiY21jbGlubm92YXRpb25zIiwiYSI6ImNrbGdqa3RoNDFnanIyem1nZXR3YzVhcmwifQ.hVk983r6YYlmFE8kSMbzhA';
       
	    // Load the map visualisation
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/light-v10',
            zoom: 6.,
            center: [-2, 53.25]
        });
		
		var lastClick = new Date();

		// On load...
        map.on('load', function () {
		           
			// Pre-load the flow data
			loadFlowData();
		
            // Sky layer that will show when the map is highly pitched
            map.addLayer({
                'id': 'sky',
                'type': 'sky',
                'paint': {
                    'sky-type': 'atmosphere'
                }
            });
			
			// 3D buildings data
			if (!map.getSource('composite')) {
				map.addSource('composite', {
					type: 'vector', 
					url: 'mapbox://mapbox.mapbox-streets-v7'}
				);
			} 
			
			// Layer style for 3D buildings
            map.addLayer({
					'id': '3d-buildings',
					'source': 'composite',
					'source-layer': 'building',
					'filter': ['==', 'extrude', 'true'],
					'type': 'fill-extrusion',
					'minzoom': 15,
					'paint': {
						'fill-extrusion-color': '#919191',
						'fill-extrusion-height': [
							'interpolate',
							['linear'],
							['zoom'],
							15,
							0,
							15.05,
							['get', 'height']
						],
						'fill-extrusion-base': [
							'interpolate',
							['linear'],
							['zoom'],
							15,
							0,
							15.05,
							['get', 'max_height']
						],
						'fill-extrusion-opacity': 0.75
					}
				},
				labelLayerId
			);
		
			// ============ PIPES ===========	
			// Add the geoJSON data for NTS
            map.addSource('National Transmission System', {
                type: 'geojson',
                data: '/geoJSON_assets/pipe_network.geojson'
            });

			// Add layer style for NTS
            map.addLayer({
                'id': 'National Transmission System',
                'type': 'line',
                'source': 'National Transmission System',
                'layout': {
                    'line-join': 'round',
                    'line-cap': 'round'
                },
                'paint': {
                    'line-color':  '#3E3E3E',
                    'line-opacity': 0.75,
                    'line-width': 3
                }
            });

			// ============ OFFTAKES ===========	
			// Add the geoJSON data for offtakes
            map.addSource('offtakes', {
                type: 'geojson',
                data: '/geoJSON_assets/offtakes.geojson'
            });

			// Add layer style for offtakes
            map.addLayer({
                'id': 'offtakes_loc',
                'type': 'circle',
                'source': 'offtakes',
                'paint': {
                    'circle-radius': 6,
                    'circle-color': '#B42222',
                    'circle-opacity': 0.9,
                    "circle-stroke-width": 1,
                    "circle-stroke-color": '#FFFFFF',
                }
            });

			// On click handler within offtake layer
            map.on('click', 'offtakes_loc', function (e) {
				// Prevent if within a second of last click
				var nowClick = new Date();
				var millis = Math.abs(nowClick.getTime() - lastClick.getTime());
				
				if(millis < 1000) return;
				lastClick = nowClick;
				
                var coordinates = e.features[0].geometry.coordinates.slice();
				//coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
				
                var name = e.features[0].properties["Offtake Point (License Name)"];
                var type = e.features[0].properties["Type of Offtake"];
				
                // Fire selection logic
                showOfftake(name, type, coordinates);

                map.flyTo({
                    center: coordinates,
                    curve: 1.9,
                    speed: 1.6,
                    pitch: 45,
                    zoom: 16
                });
            });
			
			// On mouse enter within offtake layer
            map.on('mouseenter', 'offtakes_loc', function (e) {
                map.getCanvas().style.cursor = 'pointer';
            });
			
			// On mouse leave within offtake layer
            map.on('mouseleave', 'offtakes_loc', function () {
                map.getCanvas().style.cursor = '';
            });

			// ============ TERMINALS ===========	
			// Add the geoJSON data for terminals
            map.addSource('terminals_s', {
                'type': 'geojson',
                'data': '/geoJSON_assets/terminals.geojson'
            });
						
			// Layer style for terminals
            map.addLayer({
                'id': 'terminals',
                'type': 'circle',
                'source': 'terminals_s',
                'paint': {
                    'circle-radius': 8,
                    'circle-color': '#108dcc',
                    'circle-opacity': 0.9,
                    "circle-stroke-width": 1,
                    "circle-stroke-color": '#FFFFFF',
                }
            });
			
			// On click handler within offtake layer
            map.on('click', 'terminals', function (e) {
				// Prevent if within a second of last click
				var nowClick = new Date();
				var millis = Math.abs(nowClick.getTime() - lastClick.getTime());
				
				if(millis < 1000) return;
				lastClick = nowClick;
				
				var coordinates = e.features[0].geometry.coordinates.slice();
				coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
				
                var name = e.features[0].properties.name;
                var type = "Terminal";

				// Update the side panel
				showTerminal(name, type, coordinates);
				
                map.flyTo({
                    center: coordinates,
                    curve: 1.9,
                    speed: 1.6,
                    pitch: 45,
                    zoom: 16
                });
            });


            map.addLayer({
                id: 'terminals_name',
                type: 'symbol',
                source: 'terminals_s',
                layout: {
                    'text-field': ['get','name'],
                    'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],
                    'text-size': 14,
                    'text-offset':[0,1.5],
                    },
                "paint": {
                    "text-color": "#3E3E3E",
                    "text-halo-color": "#FFFFFF",
                    "text-halo-width": 1,
                    "text-opacity": ['interpolate', ['exponential',2], ['zoom'], 6, 0, 8, 1]
                    }
                });

                map.addLayer({
                id: 'offtakes_name',
                type: 'symbol',
                source: 'offtakes',
                layout: {
                    'text-field': ['get','Offtake Point (License Name)'],
                    'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],
                    'text-size': 12,
                    'text-offset':[0,1.5]
                    },
                "paint": {
                    "text-color": "#3E3E3E",
                    "text-halo-color": "#FFFFFF",
                    "text-halo-width": 1,
                    "text-opacity": ['interpolate', ['exponential',2], ['zoom'], 6, 0, 8, 1]
                }
                });

            // On mouse enter within offtake layer
            map.on('mouseenter', 'terminals', function (e) {
                map.getCanvas().style.cursor = 'pointer';
            });
			
			// On mouse leave within offtake layer
            map.on('mouseleave', 'terminals', function () {
                map.getCanvas().style.cursor = '';
            });

			
            var layers = map.getStyle().layers;
            var labelLayerId;
            for (var i = 0; i < layers.length; i++) {
                if (layers[i].type === 'symbol' && layers[i].layout['text-field']) {
                    labelLayerId = layers[i].id;
                    break;
                }
            }
        });
    </script>
</body>

</html>

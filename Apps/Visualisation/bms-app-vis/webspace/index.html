<html>

<head>
    <!-- ===== CUSTOMISABLE ===== -->
    <title>DTVF v3.3.4</title>
    <!-- ===== CUSTOMISABLE ===== -->

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- JS -->
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js'></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.95/Build/Cesium/Cesium.js"></script>
    <script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>
    <script
        src="https://cdn.jsdelivr.net/gh/hummingbird-dev/hummingbird-treeview@v3.0.4/hummingbird-treeview.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.5.1/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-adapter-moment/1.0.0/chartjs-adapter-moment.js"></script>
    <script src="https://kg.cmclinnovations.com/cdn/dtvf/3.3.4/dtvf.min.js" charset="UTF-8"></script>

    <!-- ===== CUSTOMISABLE ===== -->
    <!-- JavaScript files to provide functionality specifically for this visualisation instance can go here. -->
    <!-- ===== CUSTOMISABLE ===== -->

    <!-- CSS -->
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.95/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/gh/hummingbird-dev/hummingbird-treeview@v3.0.4/hummingbird-treeview.min.css"
        rel="stylesheet">
    <link href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css" rel="stylesheet">
    <!-- <link href="https://kg.cmclinnovations.com/cdn/dtvf/3.3.4/dtvf.min.css" rel="stylesheet" /> -->
    <link href="dtvf_mobile.css" rel="stylesheet" />

    <!-- ===== CUSTOMISABLE ===== -->
    <!-- CSS files to provide styling specifically for this visualisation instance can go here. -->
    <!-- ===== CUSTOMISABLE ===== -->

</head>

<body>
    <!-- <div id="equipmentSelectControlContainer"></div> -->

    <div id="metaTimeContainer"></div>
</body>

<script>
    // var stack = "http://localhost:3838/";
    var stack = "http://192.168.1.6:3838/";

    function visualiseTimeSeriesData(rawJSON) {
        console.log("response received");
        let meta = rawJSON["meta"];
        let time = rawJSON["time"];

        if (meta != null) console.log("Got a meta object!");
        if (time != null) console.log("Got a time object!");

        // TODO: ignore meta for now

        document.getElementById("metaTimeContainer").innerHTML = "";

        if (time != null) {
            // Plot data
            timeseriesHandler.parseData(time);
            // for (i = 0; i < timeseriesHandler._selectedData.length; i++) {
            //     console.log(i);
            //     start = timeseriesHandler._selectedData[i].times.length - 20;
            //     end = timeseriesHandler._selectedData[i].times.length;
            //     timeseriesHandler._selectedData[i].times = timeseriesHandler._selectedData[i].times.slice(start, end);
            //     timeseriesHandler._selectedData[i].values = timeseriesHandler._selectedData[i].values.slice(start, end);
            // }

            timeseriesHandler.showData("metaTimeContainer");

            console.log($("#time-series-select").val());
            timeseriesHandler.update($("#time-series-select").val());

            // $("#time-series-select").off("change");
            $("#time-series-select").change(function() {
                console.log("selection is " + $("#time-series-select").val());
                timeseriesHandler.update($("#time-series-select").val());
            });

        } else {
            console.warn("No 'time' node found, skipping timeseries visualisation.");
        }
    }

    function refreshEquipmentSelect(rawJSON) {

        var FIAUri = stack + "feature-info-agent/get";
        var params = {
                "iri": rawJSON["equipmentIRI"]
        };
        console.log("sending request to " + FIAUri + " with params " + params.iri);
        $.ajax({
                dataType: "json",
                url: FIAUri,
                data: params,
                success: visualiseTimeSeriesData,
                error: getJSONFailure
        })
            
    }

    function getJSONFailure() {
        console.warn("Could not get valid response from the agent");
    }

    function getSelectionFromAndroidStatusAgent() {
        var AndroidStatusUri = stack + "android-status-agent/get";
        console.log("sending request to " + AndroidStatusUri);
        $.ajax({
                dataType: "json",
                url: AndroidStatusUri,
                success: refreshEquipmentSelect,
                error: getJSONFailure
        })
    }

    var timeseriesHandler = new TimeseriesHandler();

    $(document).ready(function () {
        getSelectionFromAndroidStatusAgent();
    });


</script>

</html>